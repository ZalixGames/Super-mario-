
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mario Run – Ultimate Gamer Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <!-- Ad Script 1 -->
  <script type='text/javascript' src='//pl26412649.profitableratecpm.com/13/e5/a4/13e5a43804eecf191c995f63cff90d9c.js'></script>
  <style>
    /* --- CSS Styles --- */
    /* Basic Reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Press Start 2P', cursive; overflow: hidden;
      background: #0a0a0a url('https://www.transparenttextures.com/patterns/stardust.png');
      color: #fff; margin-bottom: 50px; /* Space for banner */
    }
    canvas { display: block; } /* Ensure canvas takes block space */
    .text-glow { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #ff007f; }
    .box-glow { box-shadow: 0 0 8px rgba(255, 255, 255, 0.6), 0 0 15px rgba(255, 0, 127, 0.5); }
    .game-btn {
      padding: 12px 25px; margin: 10px; font-size: 14px; border: none;
      border-radius: 8px; cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
      background: linear-gradient(145deg, #ff4757, #ff6348); color: #fff;
      font-family: 'Press Start 2P', cursive; text-transform: uppercase;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7); border-bottom: 4px solid #c0392b;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); display: inline-flex;
      align-items: center; justify-content: center; line-height: 1.2;
    }
    .game-btn:hover:not(:disabled) {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 100, 100, 0.6);
      background: linear-gradient(145deg, #ff6348, #ff7f50);
    }
    .game-btn:active:not(:disabled) {
         transform: translateY(1px) scale(1); border-bottom-width: 2px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .game-btn:disabled { background: #555; cursor: not-allowed; border-bottom-color: #333; box-shadow: none; transform: none; opacity: 0.7; }

    /* --- Login/Signup Panel Common Styles --- */
    .auth-panel {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: url('https://i.imgur.com/nxRZ03R.png') no-repeat center center; background-size: cover;
      z-index: 100; display: none; flex-direction: column;
      justify-content: center; align-items: center; color: #fff; padding: 20px; text-align: center;
      background-color: rgba(0,0,0,0.7);
    }
    .auth-panel h2 { font-size: 2.5em; color: #ff007f; margin-bottom: 30px; text-shadow: 3px 3px 0px #000, 0 0 15px #ff007f; }
    .auth-panel input {
      width: 280px; padding: 12px 15px; margin: 8px; background: rgba(10, 10, 10, 0.8);
      border: 2px solid #ff007f; color: #fff; border-radius: 5px; font-family: 'Press Start 2P', cursive;
      font-size: 14px; outline: none; transition: border-color 0.3s, box-shadow 0.3s;
    }
    .auth-panel input:focus { border-color: #ff60af; box-shadow: 0 0 10px rgba(255, 0, 127, 0.7); }
    .auth-panel button.game-btn { width: 200px; }
    .auth-panel .switch-link { margin-top: 15px; color: #ccc; font-size: 0.9em; font-family: Arial, sans-serif; }
    .auth-panel .switch-link button { background: none; border: none; color: #ff007f; cursor: pointer; text-decoration: underline; font-family: 'Press Start 2P', cursive; font-size: 1em; padding: 0 5px; display: inline; }
    .auth-panel .switch-link button:hover { color: #ff60af; }
    #loginPanel button#loginButton { background: linear-gradient(145deg, #ff007f, #e60073); border-bottom-color: #a70057; }
    #loginPanel button#loginButton:hover:not(:disabled) { background: linear-gradient(145deg, #e60073, #ff309f); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 0, 127, 0.6); }
    #signupPanel button#performSignupBtn { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; }
    #signupPanel button#performSignupBtn:hover:not(:disabled) { background: linear-gradient(145deg, #1dd1a1, #00b894); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(46, 213, 115, 0.6); }

    /* --- Main Menu --- */
    #mainMenu {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: url('https://i.imgur.com/KFWJlte.png') no-repeat center center; background-size: cover;
      z-index: 30; display: none; /* Initially hidden */ flex-direction: column; justify-content: center; align-items: center;
      color: #fff; padding: 20px; text-align: center;
    }
    #mainMenu h1 { font-size: 3.5em; text-shadow: 4px 4px 0px rgba(0,0,0,0.8), 0 0 20px rgba(255,255,255,0.5); margin-bottom: 40px; color: #ffe64d; }
    #topRightStatus {
      position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.85); padding: 10px 15px;
      border-radius: 8px; font-size: 18px; color: #FFD700; z-index: 35; border: 2px solid #FFD700;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); display: inline-flex; align-items: center;
    }
    #topRightStatus img#coinIcon { width: 24px; height: 24px; margin-right: 8px; vertical-align: middle; }
    #settingsBtn {
      position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.8); border: 2px solid #ccc;
      border-radius: 50%; cursor: pointer; z-index: 35; width: 45px; height: 45px; display: flex;
      justify-content: center; align-items: center; transition: transform 0.2s, box-shadow 0.2s;
    }
    #settingsBtn svg { width: 24px; height: 24px; fill: #fff; }
    #settingsBtn:hover { transform: rotate(45deg) scale(1.1); box-shadow: 0 0 15px rgba(255,255,255,0.7); border-color: #fff; }
    #mainMenu .menu-btn { width: 220px; }
    #mainMenu #withdrawBtn { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; }
    #mainMenu #withdrawBtn:hover { background: linear-gradient(145deg, #1dd1a1, #00b894); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(46, 213, 115, 0.6); }
    #mainMenu #inviteFriend { background: linear-gradient(145deg, #54a0ff, #2e86de); border-bottom-color: #1e5ea8; }
    #mainMenu #inviteFriend:hover { background: linear-gradient(145deg, #2e86de, #1e66b0); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(84, 160, 255, 0.6); }
    #mainMenu #logoutBtn { background: linear-gradient(145deg, #8395a7, #576574); border-bottom-color: #2f3640; }
    #mainMenu #logoutBtn:hover { background: linear-gradient(145deg, #576574, #434c58); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 15px rgba(131, 149, 167, 0.6); }

    /* --- Game Over Menu --- */
    #gameOverMenu {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8);
      z-index: 40; display: none; flex-direction: column; justify-content: center; align-items: center;
      color: #ff4757; padding: 20px; text-align: center;
    }
    #gameOverMenu h2 { font-size: 4em; text-shadow: 4px 4px 0px #000, 0 0 20px #ff0000; margin-bottom: 20px; }
    #gameOverMenu p { font-size: 1.5em; color: #fff; margin-bottom: 10px; text-shadow: 1px 1px 2px #000; }
    #gameOverMenu .menu-btn { width: 200px; }
    #gameOverMenu #restartBtn { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; }
    #gameOverMenu #backMenuBtn { background: linear-gradient(145deg, #54a0ff, #2e86de); border-bottom-color: #1e5ea8; }

    /* --- Modal Common Styles --- */
    .modal { display: none; position: fixed; z-index: 70; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
    .modal .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e1e1e; padding: 20px 25px; border-radius: 10px; width: 90%; color: #eee; text-align: center; font-family: 'Press Start 2P', cursive; border: 3px solid #ff007f; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5), 0 0 15px rgba(255, 0, 127, 0.4); max-height: 85vh; overflow-y: auto; }
    .modal h2 { margin-bottom: 20px; font-size: 1.4em; color: #ff007f; text-shadow: 1px 1px 2px #000; }
    .modal button.game-btn { width: 100%; margin: 8px 0; padding: 10px 15px; font-size: 12px; }
    .modal input[type="text"], .modal input[type="email"], .modal input[type="password"] { width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 15px; border: 2px solid #555; border-radius: 5px; background: #333; color: #fff; font-family: 'Arial', sans-serif; font-size: 16px; outline: none; transition: border-color 0.3s, box-shadow 0.3s; }
    .modal input:focus { border-color: #ff007f; box-shadow: 0 0 8px rgba(255, 0, 127, 0.6); }
    .close-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 28px; cursor: pointer; color: #aaa; font-family: Arial, sans-serif; transition: color 0.2s, transform 0.2s; font-weight: bold; }
    .close-btn:hover { color: #ff007f; transform: scale(1.2); }

    /* --- Specific Modal Sizes --- */
    #settingsModal .modal-content { max-width: 320px; }
    #profileModal .modal-content { max-width: 380px; text-align: left; }
    #inviteModal .modal-content { max-width: 360px; }
    #withdrawModal .modal-content { max-width: 380px; }
    #infoModal .modal-content { max-width: 360px; }
    #withdrawalHistoryModal .modal-content { max-width: 450px; }

    /* --- Settings Modal Button Styles --- */
    #profileBtn { background: linear-gradient(145deg, #9b59b6, #8e44ad); border-bottom-color: #6c3483; }
    #toggleSound { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; }
    #customerService { background: linear-gradient(145deg, #54a0ff, #2e86de); border-bottom-color: #1e5ea8; }
    #withdrawalHistoryBtn { background: linear-gradient(145deg, #feca57, #ff9f43); border-bottom-color: #e67e22; }
    #profileBtn:hover { background: linear-gradient(145deg, #8e44ad, #a569bd); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(155, 89, 182, 0.6); }
    #toggleSound:hover { background: linear-gradient(145deg, #1dd1a1, #00b894); }
    #customerService:hover { background: linear-gradient(145deg, #2e86de, #1e66b0); }
    #withdrawalHistoryBtn:hover { background: linear-gradient(145deg, #ff9f43, #f39c12); }

    /* --- Profile Modal Styles --- */
    #profileModal .modal-content h2 { color: #9b59b6; }
    #profileModal .modal-content p { margin: 12px 0; font-family: Arial, sans-serif; font-size: 15px; line-height: 1.6; color: #ddd; }
    #profileModal .modal-content p strong { color: #fff; display: inline-block; min-width: 120px; }
    #profileModal .modal-content span { color: #feca57; word-break: break-all; }
    #profileInfo { border-top: 1px solid #444; margin-top: 15px; padding-top: 15px; }

    /* --- Invite Modal Styles --- */
    #inviteModal .section { margin: 20px 0; border-top: 1px solid #444; padding-top: 15px; }
    #inviteModal .section h3 { font-size: 1.1em; margin-bottom: 10px; color: #eee; }
    #inviteModal .section p { font-size: 1em; margin-bottom: 12px; font-family: Arial, sans-serif; }
    #yourInviteCode { font-size: 1.2em; color: #FFD700; background: #333; padding: 8px 12px; border-radius: 5px; display: inline-block; border: 1px solid #555; word-break: break-all; }
    #copyInviteCode { background: linear-gradient(145deg, #feca57, #ff9f43); border-bottom-color: #e67e22; }
    #redeemCodeBtn { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; }
    #copyInviteCode:hover { background: linear-gradient(145deg, #ff9f43, #f39c12); }
    #redeemCodeBtn:hover { background: linear-gradient(145deg, #1dd1a1, #00b894); }

    /* --- Withdraw Modal Styles --- */
    #withdrawModal .modal-content p { margin-bottom: 20px; font-family: Arial, sans-serif; line-height: 1.5; }
    #withdrawModal .redeem-option { background: linear-gradient(145deg, #1abc9c, #16a085); border-bottom: 4px solid #117a65; color: #fff; padding: 10px 15px; margin: 6px 0; border-radius: 8px; font-size: 13px; text-shadow: 1px 1px 1px rgba(0,0,0,0.5); transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease; width: 100%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2); }
    #withdrawModal .redeem-option:hover { background: linear-gradient(145deg, #1dd1a1, #1abc9c); transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3), 0 0 15px rgba(26, 188, 156, 0.5); }
    #withdrawModal .redeem-option:active { transform: translateY(1px); border-bottom-width: 2px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
    #redeemForm { display: none; margin-top: 20px; font-family: Arial, sans-serif; font-size: 16px; line-height: 1.5; text-align: left; }
    #redeemForm h3 { font-family: 'Press Start 2P', cursive; font-size: 1.2em; color: #eee; margin-bottom: 15px; text-align: center; }
    #redeemForm label { display: block; margin-bottom: 5px; color: #ccc; font-size: 14px; }
    #redeemForm input[type="text"] { margin-bottom: 15px; }
    #redeemForm input[type="radio"] { margin-right: 8px; vertical-align: middle; }
    #redeemForm label input[type="radio"] { display: inline; margin-bottom: 0; }
    #redeemForm .payment-options label { margin-bottom: 10px; display: block;}
    #redeemSubmitBtn { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; width: 100%; margin-top: 20px; font-size: 14px; }
    #redeemSubmitBtn:hover:not(:disabled) { background: linear-gradient(145deg, #1dd1a1, #00b894); }
    #redeemSubmitBtn:disabled { background: #555; cursor: not-allowed; border-bottom-color: #333; box-shadow: none; transform: none; opacity: 0.7;}

    /* --- Info Modal Styles --- */
    #infoModal .modal-content h2 { color: #54a0ff; }
    #infoModal .modal-content p { margin: 15px 0; font-family: Arial, sans-serif; font-size: 15px; line-height: 1.6; color: #ddd; text-align: left; }
    #infoModal .modal-content p strong { color: #fff; }

    /* --- Withdrawal History Modal Styles --- */
    #withdrawalHistoryModal .modal-content h2 { color: #feca57; }
    #historyList { margin-top: 20px; max-height: 50vh; overflow-y: auto; padding-right: 10px; text-align: left; font-family: Arial, sans-serif; font-size: 14px; line-height: 1.5; }
    .history-item { background: #2a2a2a; border: 1px solid #444; border-radius: 6px; padding: 12px 15px; margin-bottom: 10px; color: #ccc; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; }
    .history-item span { display: block; margin-bottom: 4px; }
    .history-item .details { flex-grow: 1; margin-right: 10px; }
    .history-item .status { font-family: 'Press Start 2P', cursive; font-size: 12px; padding: 4px 8px; border-radius: 4px; text-transform: uppercase; min-width: 80px; text-align: center; margin-top: 5px; }
    .history-item .status-pending { background-color: #ff9f43; color: #573a0a; border: 1px solid #e67e22;}
    .history-item .status-approved { background-color: #2ed573; color: #0a4a2f; border: 1px solid #10ac84;}
    .history-item .status-rejected { background-color: #ff4757; color: #5e141e; border: 1px solid #c0392b;}
    .history-item .date { font-size: 12px; color: #888; width: 100%; text-align: right; margin-top: 5px; }
    #historyList .no-history { color: #888; text-align: center; padding: 20px; font-size: 1em;}

    /* --- Ad Container Styles --- */
    #bannerAdContainer { position: fixed; bottom: 0; left: 0; width: 100%; height: 50px; background-color: #000; z-index: 1000; display: flex; justify-content: center; align-items: center; overflow: hidden; border-top: 2px solid #333; }
    #bannerAdContainer iframe { max-width: 100%; }
    #interstitialAdOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; font-family: 'Press Start 2P', cursive; padding: 20px; backdrop-filter: blur(3px); }
    #interstitialAdOverlay p#adInfoText { font-size: 1.1em; margin-bottom: 25px; color: #eee; line-height: 1.5; }
    #interstitialAdCloseButton { padding: 12px 25px; font-size: 1em; cursor: pointer; background: linear-gradient(145deg, #ff4757, #e84118); border-bottom-color: #c23616; color: white; border-radius: 8px; font-family: 'Press Start 2P', cursive; display: none; text-transform: uppercase; margin-top: 20px; }
    #interstitialAdCloseButton:hover { background: linear-gradient(145deg, #e84118, #d63031); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 71, 87, 0.6); }
    #interstitialAdTimer { margin-top: 15px; font-size: 0.9em; color: #ccc; }
    #interstitialAdOverlay p.skip-info { font-size: 0.8em; color: #aaa; margin-top: 30px; font-family: Arial, sans-serif; line-height: 1.4; }

    /* --- Status Message Container --- */
    #statusMessageContainer { display: none; position: fixed; top: 15px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.85); color: white; padding: 12px 25px; border-radius: 8px; z-index: 5000; font-family: 'Press Start 2P', cursive; font-size: 0.9em; text-align: center; border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5); opacity: 0; transition: opacity 0.4s ease-in-out; max-width: 90%; pointer-events: none; }
    #statusMessageContainer.show { display: block; opacity: 1; }
    #statusMessageContainer.success { border-color: #2ed573; }
    #statusMessageContainer.error { border-color: #ff4757; }
    #statusMessageContainer.info { border-color: #54a0ff; }

    /* --- End of CSS --- */
  </style>
</head>
<body>
  <!-- Status Message Container -->
  <div id="statusMessageContainer"> <span id="statusMessageText"></span> </div>

  <!-- Audio Elements -->
  <audio id="backgroundAudio" loop> <source src="mines background .mp3" type="audio/mp3"> Your browser does not support the audio element. </audio>
  <audio id="jumpSound"> <source src="gruntjumpland-101soundboards.mp3" type="audio/mp3"> </audio>
  <audio id="coinSound"> <source src="coin-recieved-230517.mp3" type="audio/mp3"> </audio>
  <audio id="gameOverSound"> <source src="game-over-arcade-6435.mp3" type="audio/mp3"> </audio>

  <!-- Login Panel -->
  <div id="loginPanel" class="auth-panel" style="display: flex;">
    <h2>Gamer Login</h2>
    <input type="email" id="loginEmail" placeholder="Email" />
    <input type="password" id="loginPassword" placeholder="Password" />
    <button id="loginButton" class="game-btn">Login</button>
    <button id="guestButton" class="game-btn">Continue Guest</button>
    <p class="switch-link">Don't have an account? <button id="switchToSignupBtn">Sign Up</button></p>
  </div>

  <!-- Signup Panel -->
  <div id="signupPanel" class="auth-panel" style="display: none;">
      <h2>Create Account</h2>
      <input type="email" id="signupEmail" placeholder="Email" required />
      <input type="text" id="signupUsername" placeholder="Username" required />
      <input type="password" id="signupPassword" placeholder="Password (min. 6 chars)" required />
      <input type="password" id="signupConfirmPassword" placeholder="Confirm Password" required />
      <input type="text" id="signupReferralCode" placeholder="Referral Code (Optional)" />
      <button id="performSignupBtn" class="game-btn">Sign Up</button>
      <p class="switch-link">Already have an account? <button id="switchToLoginBtn">Login</button></p>
  </div>

  <!-- Game Canvas -->
  <canvas id="gameCanvas" style="display: none;"></canvas>

  <!-- Main Menu -->
  <div id="mainMenu" style="display: none;">
     <button id="settingsBtn" title="Open Settings">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M487.4 315.7l-42.1-24.3c2.8-12.8 4.3-26 4.3-39.4s-1.5-26.6-4.3-39.4l42.1-24.3c9.4-5.4 13.3-17.1 9.4-27.2l-45.3-78.4c-3.9-10.1-14.2-14.8-24.7-11.5l-49.5 19.9c-20.5-16.1-43-29.2-67.2-38.1l-7.5-52.8C309 3.7 300.3-2.5 290.3.1l-90.6 18.5c-10 2.1-17.6 9.9-19.8 19.8l-7.5 52.8c-24.3 8.9-46.8 22-67.2 38.1L54.6 83.1c-10.5-3.3-20.8.4-24.7 11.5L-15.4 172.9c-3.9 10.1-.1 21.8 9.4 27.2l42.1 24.3C73.5 243.3 72 256.4 72 269.9c0 13.5 1.5 26.6 4.3 39.4l-42.1 24.3c-9.4 5.4-13.3 17.1-9.4 27.2l45.3 78.4c3.9 10.1 14.2 14.8 24.7 11.5l49.5-19.9c20.5 16.1 43 29.2 67.2 38.1l7.5 52.8c2 10 10.7 15.3 20.7 12.8l90.6-18.5c10-2.1 17.6-9.9 19.8-19.8l7.5-52.8c24.3-8.9 46.8-22 67.2-38.1l49.5 19.9c10.5 3.3 20.8-.4 24.7-11.5l45.3-78.4c3.9-10.1.1-21.8-9.4-27.2zM256 336c-44.2 0-80-35.8-80-80s35.8-80 80-80c44.2 0 80 35.8 80 80s-35.8 80-80 80z"></path></svg>
     </button>
     <div id="topRightStatus"> <img id="coinIcon" src="https://i.imgur.com/PCDgdlS.png" alt="Coin"> Coins: <span id="menuCoinCount">0</span> </div>
     <h1>Mario Run</h1>
     <button id="startBtn" class="menu-btn game-btn">Play Now</button>
     <button id="withdrawBtn" class="menu-btn game-btn">Withdraw Coins</button>
     <button id="inviteFriend" class="menu-btn game-btn">Invite (0 Refs)</button>
     <button id="infoBtn" class="menu-btn game-btn">Game Info</button>
     <button id="logoutBtn" class="menu-btn game-btn">Exit Game</button>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeSettings">×</button>
      <h2>Settings</h2>
      <button id="profileBtn" class="game-btn">View Profile</button>
      <button id="toggleSound" class="game-btn">Sound: On</button>
      <button id="withdrawalHistoryBtn" class="game-btn">Withdrawal History</button>
      <button id="customerService" class="game-btn">Customer Service</button>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="modal">
      <div class="modal-content">
          <button class="close-btn" id="closeProfileModal">×</button>
          <h2>Gamer Profile</h2>
          <div id="profileInfo">
              <p><strong>Username:</strong> <span id="profileUsername">...</span></p>
              <p><strong>Email:</strong> <span id="profileEmail">...</span></p>
              <p><strong>Total Coins:</strong> <span id="profileTotalCoins">...</span></p>
              <p><strong>Referrals:</strong> <span id="profileReferralCount">...</span></p>
              <p><strong>Your Code:</strong> <span id="profileInviteCode">...</span></p>
              <p><strong>Joined:</strong> <span id="profileJoinedDate">...</span></p>
          </div>
      </div>
  </div>

  <!-- Invite Modal -->
  <div id="inviteModal" class="modal">
      <div class="modal-content">
          <button class="close-btn" id="closeInviteModal">×</button>
          <h2>Invite Friend</h2>
          <div class="section">
              <h3>Your Invite Link</h3>
              <p id="yourInviteCode">...</p>
              <button id="copyInviteCode" class="game-btn">Copy Link</button>
          </div>
          <div class="section">
              <h3>Redeem Invite Code</h3>
              <input type="text" id="redeemCodeInput" placeholder="Enter friend's code" />
              <button id="redeemCodeBtn" class="game-btn">Redeem</button>
          </div>
      </div>
  </div>

  <!-- Game Over Overlay -->
  <div id="gameOverMenu" style="display: none;">
      <h2>Game Over</h2>
      <p>Session Coins: <span id="sessionCoinCount">0</span></p>
      <p>Total Coins: <span id="finalTotalCoins">0</span></p>
      <button id="restartBtn" class="menu-btn game-btn">Restart</button>
      <button id="backMenuBtn" class="menu-btn game-btn">Back to Menu</button>
  </div>

  <!-- Withdraw Modal -->
  <div id="withdrawModal" class="modal">
     <div class="modal-content">
         <button class="close-btn" id="closeWithdraw">×</button>
         <h2>Redeem Coins</h2>
         <p>Select an option:</p>
         <div id="redeemOptions">
             <button class="redeem-option" data-coins="10000" data-pkr="100">10k Coins - 100 PKR</button>
             <button class="redeem-option" data-coins="30000" data-pkr="300">30k Coins - 300 PKR</button>
             <button class="redeem-option" data-coins="50000" data-pkr="500">50k Coins - 500 PKR</button>
             <button class="redeem-option" data-coins="80000" data-pkr="800">80k Coins - 800 PKR</button>
             <button class="redeem-option" data-coins="100000" data-pkr="1000">100k Coins - 1000 PKR</button>
             <button class="redeem-option" data-coins="500000" data-pkr="5000">500k Coins - 5000 PKR</button>
         </div>
         <div id="redeemForm" style="display: none;">
             <h3>Enter Details</h3>
             <form id="redeemDetailsForm">
                 <div><label for="accountHolderName">Account Name:</label><input type="text" id="accountHolderName" required /></div>
                 <div><label for="accountNumber">Account Number:</label><input type="text" id="accountNumber" required /></div>
                 <div class="payment-options" style="margin-top: 15px;">
                     <label>Method:</label>
                     <label><input type="radio" name="paymentMethod" value="JazzCash" required> JazzCash</label>
                     <label><input type="radio" name="paymentMethod" value="EasyPaisa" required> EasyPaisa</label>
                 </div>
                 <button type="submit" id="redeemSubmitBtn" class="game-btn">Submit Request</button>
             </form>
         </div>
     </div>
  </div>

  <!-- Game Info Modal -->
  <div id="infoModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeInfo">×</button>
      <h2>Game Info</h2>
      <p>Welcome to <strong>Mario Run  Earn Real Money</strong>...</p>
      <p><strong>Online Play:</strong> Login/Signup to save coins...</p>
      <p><strong>Offline Play (Guest):</strong> Play for fun! Coins are not saved...</p>
      <p><strong>Invite Friends:</strong> Share link, earn bonus coins...</p>
      <p><strong>Withdrawals:</strong> Redeem via JazzCash/EasyPaisa...</p>
      <p><strong>Profile:</strong> View details in Settings > View Profile.</p>
    </div>
  </div>

  <!-- Withdrawal History Modal -->
  <div id="withdrawalHistoryModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeHistoryModal">×</button>
      <h2>Withdrawal History</h2>
      <div id="historyList"> <p class="no-history">Loading...</p> </div>
    </div>
  </div>

  <!-- AD INTEGRATION -->
  <div id="bannerAdContainer">
    <script type="text/javascript"> atOptions = {'key' : '84c9a4eabdeffe242051226bdf854fd8', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {}}; </script>
    <script type="text/javascript" src="//www.highperformanceformat.com/84c9a4eabdeffe242051226bdf854fd8/invoke.js"></script>
  </div>
  <div id="interstitialAdOverlay" style="display: none;">
      <p id="adInfoText">Loading ad...</p>
      <div id="interstitialAdTimer"></div>
      <button id="interstitialAdCloseButton" class="game-btn" style="display: none;">Skip Ad</button>
      <p class="skip-info">(Click 'Skip Ad' or close ad tab manually)</p>
  </div>

  <!-- Firebase and Game Scripts -->
  <script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
    import { getDatabase, ref, set, get, push, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";

    // --- DOM Element References (Ensure ALL are listed) ---
    const loginPanel = document.getElementById('loginPanel');
    const signupPanel = document.getElementById('signupPanel');
    const mainMenu = document.getElementById('mainMenu');
    const gameOverMenu = document.getElementById('gameOverMenu');
    const gameCanvas = document.getElementById('gameCanvas');
    const settingsModal = document.getElementById('settingsModal');
    const profileModal = document.getElementById('profileModal');
    const inviteModal = document.getElementById('inviteModal');
    const withdrawModal = document.getElementById('withdrawModal');
    const infoModal = document.getElementById('infoModal');
    const withdrawalHistoryModal = document.getElementById('withdrawalHistoryModal');
    const historyListDiv = document.getElementById('historyList');
    const interstitialAdOverlay = document.getElementById('interstitialAdOverlay');
    const interstitialAdCloseButton = document.getElementById('interstitialAdCloseButton');
    const interstitialAdTimer = document.getElementById('interstitialAdTimer');
    const adInfoText = document.getElementById('adInfoText');
    const menuCoinCountSpan = document.getElementById('menuCoinCount');
    const finalTotalCoinsSpan = document.getElementById('finalTotalCoins');
    const sessionCoinCountSpan = document.getElementById('sessionCoinCount');
    const inviteFriendBtn = document.getElementById('inviteFriend');
    const yourInviteCodeP = document.getElementById('yourInviteCode');
    const redeemCodeInput = document.getElementById("redeemCodeInput");
    const toggleSoundBtn = document.getElementById("toggleSound");
    const redeemOptionsDiv = document.getElementById("redeemOptions");
    const redeemFormDiv = document.getElementById("redeemForm");
    const redeemDetailsForm = document.getElementById("redeemDetailsForm");
    const redeemSubmitBtn = document.getElementById('redeemSubmitBtn');
    const withdrawalHistoryBtn = document.getElementById('withdrawalHistoryBtn');
    const closeHistoryModalBtn = document.getElementById('closeHistoryModal');
    const profileBtn = document.getElementById('profileBtn');
    const closeProfileModalBtn = document.getElementById('closeProfileModal');
    const profileUsernameSpan = document.getElementById('profileUsername');
    const profileEmailSpan = document.getElementById('profileEmail');
    const profileTotalCoinsSpan = document.getElementById('profileTotalCoins');
    const profileReferralCountSpan = document.getElementById('profileReferralCount');
    const profileInviteCodeSpan = document.getElementById('profileInviteCode');
    const profileJoinedDateSpan = document.getElementById('profileJoinedDate');
    const statusMessageContainer = document.getElementById('statusMessageContainer');
    const statusMessageText = document.getElementById('statusMessageText');
    let statusMessageTimeoutId = null;
    const loginEmailInput = document.getElementById('loginEmail');
    const loginPasswordInput = document.getElementById('loginPassword');
    const loginButton = document.getElementById('loginButton');
    const guestButton = document.getElementById('guestButton');
    const switchToSignupBtn = document.getElementById('switchToSignupBtn');
    const signupEmailInput = document.getElementById('signupEmail');
    const signupUsernameInput = document.getElementById('signupUsername');
    const signupPasswordInput = document.getElementById('signupPassword');
    const signupConfirmPasswordInput = document.getElementById('signupConfirmPassword');
    const signupReferralCodeInput = document.getElementById('signupReferralCode');
    const performSignupBtn = document.getElementById('performSignupBtn');
    const switchToLoginBtn = document.getElementById('switchToLoginBtn');
    const backgroundAudio = document.getElementById("backgroundAudio");
    const jumpSound = document.getElementById("jumpSound");
    const coinSound = document.getElementById("coinSound");
    const gameOverSound = document.getElementById("gameOverSound");
    const settingsBtn = document.getElementById('settingsBtn'); // Make sure settings button has ref
    const closeSettings = document.getElementById('closeSettings'); // Make sure close button has ref


    const firebaseConfig = {
      apiKey: "AIzaSyCxqQEPU7qpEGleQXok7OFAyAouOrccoUY", authDomain: "test1-f9ef8.firebaseapp.com",
      databaseURL: "https://test1-f9ef8-default-rtdb.firebaseio.com", projectId: "test1-f9ef8",
      storageBucket: "test1-f9ef8.appspot.com", messagingSenderId: "709839711061",
      appId: "1:709839711061:web:ae8cc321d2ddac66c91ddc", measurementId: "G-K4Q94MBQDT"
    };

    // --- Firebase Initialization ---
    let appFirebase, db, auth;
    try {
        appFirebase = initializeApp(firebaseConfig); db = getDatabase(appFirebase); auth = getAuth();
        console.log("Firebase initialized.");
    } catch (error) { console.error("Firebase init failed:", error); showStatusMessage("Connection error.", "error", 5000); }

    // --- Global State ---
    let totalCoins = 0, soundEnabled = true, currentUserInviteCode = null, currentUsername = null;
    let currentReferralCount = 0, currentJoinedDate = null, gameStarted = false, gameOver = false;
    let score = 0, mario, obstacles, coins, speed, bgX, platformX;
    let lastJumpInputTime = 0; const doubleJumpWindow = 350; let canDoubleJump = false;
    let animationFrameId = null, allImagesLoaded = false, restartAttempts = 0, isProcessingAuth = false;

    // --- Status Message Function ---
    function showStatusMessage(message, type = 'info', duration = 3000) {
        if (statusMessageTimeoutId) { clearTimeout(statusMessageTimeoutId); statusMessageContainer.classList.remove('show'); }
        console.log(`Status [${type}]: ${message}`); statusMessageText.textContent = message;
        statusMessageContainer.className = 'statusMessageContainer'; statusMessageContainer.classList.add(type);
        statusMessageContainer.style.display = 'block'; void statusMessageContainer.offsetWidth; statusMessageContainer.classList.add('show');
        statusMessageTimeoutId = setTimeout(() => { statusMessageContainer.classList.remove('show'); statusMessageTimeoutId = null; setTimeout(() => { if (!statusMessageContainer.classList.contains('show')) { statusMessageContainer.style.display = 'none'; } }, 400); }, duration);
    }

    // --- AD INTEGRATION ---
    const directLinkUrl = "https://www.profitableratecpm.com/ycus2u5z?key=6d1f652cb3c1d695c1a7cb556f20002a";
    let adCloseTimerInterval; let adCloseTimeout; let currentAdCallback = null;
    function showInterstitialAd(callback) {
        console.log("Attempting Ad...");
        if (typeof callback !== 'function') { console.error("Invalid ad callback."); return; }
        currentAdCallback = callback;
        adInfoText.textContent = "Ad loading..."; interstitialAdOverlay.style.display = 'flex';
        interstitialAdCloseButton.style.display = 'none'; interstitialAdTimer.textContent = "";
        let adWindow = null;
        try { adWindow = window.open(directLinkUrl, '_blank'); } catch (e) { console.error("Error opening ad window:", e); }
        if (!adWindow) { console.warn("Pop-up blocked or failed?"); showStatusMessage("Ad blocked? Proceeding...", "info"); interstitialAdOverlay.style.display = 'none'; if (currentAdCallback) { try { currentAdCallback(); } catch (e) { console.error("Error in callback after ad block:", e); } } currentAdCallback = null; return; }

        let secondsRemaining = 3; interstitialAdTimer.textContent = `Skip in ${secondsRemaining}s`;
        if (adCloseTimerInterval) clearInterval(adCloseTimerInterval); if (adCloseTimeout) clearTimeout(adCloseTimeout);
        adCloseTimerInterval = setInterval(() => { secondsRemaining--; if (secondsRemaining > 0) { interstitialAdTimer.textContent = `Skip in ${secondsRemaining}s`; } else { interstitialAdTimer.textContent = "Skip available"; clearInterval(adCloseTimerInterval); } }, 1000);
        adCloseTimeout = setTimeout(() => { interstitialAdCloseButton.style.display = 'block'; if (adCloseTimerInterval) clearInterval(adCloseTimerInterval); interstitialAdTimer.textContent = "Skip available"; }, secondsRemaining * 1000 + 100);
    }
    interstitialAdCloseButton.addEventListener('click', () => {
        console.log("Ad Skip Button"); interstitialAdOverlay.style.display = 'none';
        if (adCloseTimerInterval) clearInterval(adCloseTimerInterval); if (adCloseTimeout) clearTimeout(adCloseTimeout);
        interstitialAdTimer.textContent = "";
        if (typeof currentAdCallback === 'function') { console.log("Executing callback after skip."); try { currentAdCallback(); } catch(e) { console.error("Error in ad callback:", e); showStatusMessage("Error after ad.", "error"); } currentAdCallback = null; }
        else { console.warn("No ad callback found."); }
    });

    // --- Sound Functions ---
    function playSound(audioElement) { if (soundEnabled && audioElement) { try { audioElement.currentTime=0; audioElement.play().catch(e=>console.log(`Sound err (${audioElement.id}):`, e)); } catch(e) { console.warn("Sound fail:", e); } } }
    function playBackgroundMusic() { if (soundEnabled && backgroundAudio && backgroundAudio.paused) { backgroundAudio.play().catch(e=>console.warn("BG music fail:",e)); } }
    function stopBackgroundMusic() { if (backgroundAudio && !backgroundAudio.paused) { backgroundAudio.pause(); backgroundAudio.currentTime=0; } }

    // --- Auth Panel Switching ---
    switchToSignupBtn.addEventListener('click', () => { if(isProcessingAuth) return; loginPanel.style.display = 'none'; signupPanel.style.display = 'flex'; });
    switchToLoginBtn.addEventListener('click', () => { if(isProcessingAuth) return; signupPanel.style.display = 'none'; loginPanel.style.display = 'flex'; });

    // --- Authentication Logic ---
    function setAuthProcessing(isProcessing) {
        console.log("Set Auth Processing:", isProcessing); isProcessingAuth = isProcessing;
        loginButton.disabled = isProcessing; performSignupBtn.disabled = isProcessing; guestButton.disabled = isProcessing;
    }

    function handleAuthSuccess() {
        console.log("handleAuthSuccess: Preparing main menu flow.");
        // No need to call setAuthProcessing(false) here, it's done after the ad callback finishes.
        showInterstitialAd(() => {
            console.log("handleAuthSuccess Ad Callback: Loading user data and showing main menu.");
            try {
                loadUserData(); // Load data
                showMainMenu(); // Show menu (handles hiding other panels)
                checkUrlForReferral();
                setAuthProcessing(false); // Re-enable buttons *after* success
                console.log("handleAuthSuccess Ad Callback: Finished.");
            } catch (error) {
                console.error("Error inside handleAuthSuccess ad callback:", error);
                showStatusMessage("Error loading game.", "error", 5000);
                setAuthProcessing(false); // Ensure buttons re-enabled on error
                // Fallback: show login panel?
                signOut(auth); // Log out if critical error
                signupPanel.style.display="none"; loginPanel.style.display="flex"; mainMenu.style.display="none";
            }
        });
    }

    loginButton.addEventListener("click", () => {
      if (isProcessingAuth) return;
      const email = loginEmailInput.value.trim(); const password = loginPasswordInput.value;
      if (!email || !password) { showStatusMessage("Enter email & password.", "error"); return; }
      setAuthProcessing(true); showStatusMessage("Logging in...", "info", 2000); console.log(`Attempting login: ${email}`);
      signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => { console.log("Firebase login OK:", userCredential.user.uid); handleAuthSuccess(); }) // handleAuthSuccess calls setAuthProcessing(false) later
        .catch(err => { setAuthProcessing(false); console.error("Login Error:", err.code, err.message); if (err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') { showStatusMessage("Incorrect email or password.", "error", 4000); } else if (err.code === 'auth/invalid-email') { showStatusMessage("Invalid email format.", "error"); } else if (err.code === 'auth/network-request-failed') { showStatusMessage("Network error.", "error"); } else { showStatusMessage("Login Error. Try again.", "error"); } });
    });

    performSignupBtn.addEventListener("click", () => {
        if (isProcessingAuth) return; console.log("Signup clicked.");
        const email = signupEmailInput.value.trim(); const username = signupUsernameInput.value.trim();
        const password = signupPasswordInput.value; const confirmPassword = signupConfirmPasswordInput.value;
        const referralCode = signupReferralCodeInput.value.trim().toUpperCase();
        // Validation...
        if (!email || !username || !password || !confirmPassword) { showStatusMessage("Fill required fields.", "error"); return; }
        if (username.length < 3) { showStatusMessage("Username >= 3 chars.", "error"); return; }
        if (password.length < 6) { showStatusMessage("Password >= 6 chars.", "error"); return; }
        if (password !== confirmPassword) { showStatusMessage("Passwords don't match.", "error"); return; }
        if (!/\S+@\S+\.\S+/.test(email)) { showStatusMessage("Invalid email.", "error"); return; }
        console.log("Signup validation OK."); setAuthProcessing(true); showStatusMessage("Creating account...", "info", 3000);

        createUserWithEmailAndPassword(auth, email, password)
            .then(async (userCredential) => {
                const user = userCredential.user; const creationTime = user.metadata.creationTime; console.log("1: Firebase user created:", user.uid);
                const generatedInviteCode = generateRandomCode(); const initialUserData = { email: user.email, username: username, uid: user.uid, totalCoins: 0, referralCount: 0, referralRedeemed: false, inviteCode: generatedInviteCode, createdAt: creationTime || Date.now() };
                console.log("2: Setting DB data..."); await set(ref(db, "users/" + user.uid), initialUserData); console.log("3: DB data set.");
                let referralMessage = ""; let finalCoins = 0;
                if (referralCode) {
                    console.log(`4: Attempting referral: ${referralCode}`); try { const { newCoins, rBonus, fBonus } = await redeemInviteCode(referralCode, user.uid, initialUserData); console.log("5: Referral OK."); referralMessage = ` +${fBonus} bonus coins!`; finalCoins = newCoins; } catch (redeemError) { console.warn("5: Referral error:", redeemError.message); referralMessage = ` (Referral error: ${redeemError.message})`; finalCoins = initialUserData.totalCoins; }
                } else { finalCoins = initialUserData.totalCoins; }
                totalCoins = finalCoins; console.log("Local totalCoins updated:", totalCoins);
                showStatusMessage("Account created!" + referralMessage, "success", 4000);
                handleAuthSuccess(); // handleAuthSuccess calls setAuthProcessing(false) later
            })
            .catch(err => { setAuthProcessing(false); console.error("Signup Error:", err.code, err.message); if (err.code === 'auth/email-already-in-use') { showStatusMessage("Email already registered. Login?", "error", 4000); } else if (err.code === 'auth/weak-password') { showStatusMessage("Password too weak.", "error"); } else if (err.code === 'auth/network-request-failed') { showStatusMessage("Network error.", "error"); } else { showStatusMessage("Signup Error: " + err.message, "error"); } });
    });

    guestButton.addEventListener("click", () => {
        if (isProcessingAuth) return; console.log("Guest clicked."); setAuthProcessing(true);
        try {
            loginPanel.style.display = "none"; signupPanel.style.display = "none"; console.log("Auth panels hidden for guest.");
            resetAppStateToLoggedOut(); console.log("State reset for guest.");
            showMainMenu(); console.log("showMainMenu called for guest.");
            showStatusMessage("Playing as Guest. Coins not saved.", "info", 4000);
            setAuthProcessing(false); // Re-enable after setup
        } catch (error) { console.error("Guest mode error:", error); showStatusMessage("Error entering guest mode.", "error"); setAuthProcessing(false); loginPanel.style.display = "flex"; }
    });

    // --- Auth State Change Listener ---
    onAuthStateChanged(auth, (user) => {
      console.log("Auth State Changed. User:", user ? user.uid : 'null'); setAuthProcessing(false); // Ensure buttons enabled on state change resolution
      if(user){ if(loginPanel.style.display !== 'flex' && signupPanel.style.display !== 'flex'){ console.log("Session found, ensuring main menu."); loadUserData(); showMainMenu(); checkUrlForReferral(); } else { console.log("Auth state change, but auth panel active."); } }
      else { console.log("User signed out. Showing login panel."); resetAppStateToLoggedOut(); signupPanel.style.display="none"; loginPanel.style.display="flex"; mainMenu.style.display="none"; gameCanvas.style.display='none'; gameOverMenu.style.display='none'; settingsModal.style.display="none"; profileModal.style.display="none"; inviteModal.style.display="none"; withdrawModal.style.display="none"; infoModal.style.display="none"; withdrawalHistoryModal.style.display = "none"; }
    });

    // --- Reset & Load Data ---
    function resetAppStateToLoggedOut() { console.log("Resetting state..."); totalCoins=0; currentUserInviteCode=null; currentUsername=null; currentReferralCount=0; currentJoinedDate=null; gameStarted=false; gameOver=false; score=0; if(animationFrameId) cancelAnimationFrame(animationFrameId); animationFrameId=null; stopBackgroundMusic(); menuCoinCountSpan.innerText="0"; finalTotalCoinsSpan.innerText="0"; updateInviteButtonText(0); yourInviteCodeP.textContent="N/A (Guest)"; mario=null; obstacles=[]; coins=[]; restartAttempts=0; }
    function loadUserData() { const user = auth.currentUser; if (!user) { console.log("loadUserData: No user."); resetAppStateToLoggedOut(); return; } console.log("Loading data for:", user.uid); get(ref(db, "users/" + user.uid)).then(snapshot => { if (snapshot.exists()) { const d = snapshot.val(); console.log("User data:", d); totalCoins = d.totalCoins || 0; currentUsername = d.username || user.email; currentReferralCount = d.referralCount || 0; currentUserInviteCode = d.inviteCode; if (d.createdAt) { try { currentJoinedDate = new Date(d.createdAt).toLocaleDateString(); } catch (e) { currentJoinedDate = "N/A"; } } else { currentJoinedDate = "N/A"; } menuCoinCountSpan.innerText = totalCoins; finalTotalCoinsSpan.innerText = totalCoins; updateInviteButtonText(currentReferralCount); yourInviteCodeP.textContent = currentUserInviteCode || "..."; if (!currentUserInviteCode) { console.log("Generating missing invite code."); const c=generateRandomCode(); set(ref(db, "users/"+user.uid+"/inviteCode"),c).then(()=>{currentUserInviteCode=c;yourInviteCodeP.textContent=c;}).catch(e=>console.error("Code gen err:",e)); } } else { console.error("CRITICAL: User node missing:", user.uid); showStatusMessage("Profile load error. Logging out.", "error", 5000); resetAppStateToLoggedOut(); signOut(auth); } }).catch(error => { console.error("DB load error:", error); showStatusMessage("Failed to load data.", "error"); resetAppStateToLoggedOut(); }); }
    function checkUrlForReferral() { const p=new URLSearchParams(window.location.search),c=p.get('ref'); if(c&&!auth.currentUser&&signupReferralCodeInput){ signupReferralCodeInput.value=c.trim().toUpperCase(); console.log("Ref code pre-filled (signup):",c); } else if (c&&auth.currentUser&&redeemCodeInput){ redeemCodeInput.value=c.trim().toUpperCase(); console.log("Ref code pre-filled (redeem):",c); } if(c){ try{window.history.replaceState({},document.title,window.location.pathname);}catch(e){} } }

    // --- UI Update & View Navigation ---
    function updateInviteButtonText(count) { inviteFriendBtn.innerText = `Invite (${count || 0} Refs)`; }
    function updateSoundButton() { toggleSoundBtn.textContent=`Sound: ${soundEnabled?'On':'Off'}`; const on="linear-gradient(145deg, #2ed573, #1dd1a1)", off="linear-gradient(145deg, #8395a7, #576574)"; toggleSoundBtn.style.background=soundEnabled?on:off; toggleSoundBtn.style.borderBottomColor=soundEnabled?'#10ac84':'#2f3640'; }
    function showMainMenu() { console.log("Showing Main Menu..."); gameStarted = false; gameOver = false; if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; } console.log("Hiding other views..."); loginPanel.style.display = "none"; signupPanel.style.display = "none"; gameOverMenu.style.display = "none"; gameCanvas.style.display = "none"; console.log("Hiding modals..."); settingsModal.style.display = "none"; profileModal.style.display = "none"; inviteModal.style.display = "none"; withdrawModal.style.display = "none"; infoModal.style.display = "none"; withdrawalHistoryModal.style.display = "none"; console.log("Displaying Main Menu..."); mainMenu.style.display = "flex"; if (auth.currentUser) { console.log("User logged in, menu shown."); } else { console.log("Guest, menu shown."); } playBackgroundMusic(); console.log("showMainMenu finished."); }
    function showGameOverMenu() { console.log("Showing Game Over Menu"); sessionCoinCountSpan.innerText=score; finalTotalCoinsSpan.innerText=totalCoins; gameOverMenu.style.display="flex"; mainMenu.style.display="none"; gameCanvas.style.display='none'; stopBackgroundMusic(); }

    // --- Settings & Profile Modals ---
    settingsBtn.addEventListener("click", () => { if (!auth.currentUser) { showStatusMessage("Log in for settings.", "info"); return; } updateSoundButton(); settingsModal.style.display = "block"; });
    closeSettings.addEventListener("click", () => { settingsModal.style.display = "none"; });
    toggleSoundBtn.addEventListener("click", () => { soundEnabled = !soundEnabled; updateSoundButton(); if (!soundEnabled) stopBackgroundMusic(); else if (mainMenu.style.display==='flex'||(gameStarted&&!gameOver)) playBackgroundMusic(); });
    customerService.addEventListener("click", () => { window.open("https://wa.me/923019022815", "_blank"); });
    profileBtn.addEventListener('click', showProfileModal);
    closeProfileModalBtn.addEventListener('click', () => { profileModal.style.display = 'none'; });
    function showProfileModal() { const user = auth.currentUser; if (!user) { showStatusMessage("Log in to view profile.", "error"); return; } profileUsernameSpan.textContent = currentUsername || 'N/A'; profileEmailSpan.textContent = user.email || 'N/A'; profileTotalCoinsSpan.textContent = totalCoins; profileReferralCountSpan.textContent = currentReferralCount; profileInviteCodeSpan.textContent = currentUserInviteCode || 'N/A'; profileJoinedDateSpan.textContent = currentJoinedDate || 'N/A'; settingsModal.style.display = 'none'; profileModal.style.display = 'block'; }

    // --- Withdrawal History ---
    withdrawalHistoryBtn.addEventListener('click', showWithdrawalHistory);
    closeHistoryModalBtn.addEventListener('click', () => { withdrawalHistoryModal.style.display = 'none'; });
    async function showWithdrawalHistory() { const user = auth.currentUser; if (!user) { showStatusMessage("Log in to view history.", "error"); return; } historyListDiv.innerHTML = '<p class="no-history">Loading...</p>'; withdrawalHistoryModal.style.display = 'block'; settingsModal.style.display = 'none'; try { const q = query(ref(db, 'withdrawRequests'), orderByChild('uid'), equalTo(user.uid)); const s = await get(q); historyListDiv.innerHTML = ''; if (s.exists()) { const data = []; s.forEach(cs => data.push(cs.val())); data.sort((a, b) => b.timestamp - a.timestamp); data.forEach(item => { const div = document.createElement('div'); div.classList.add('history-item'); const date = new Date(item.timestamp); const fmtDate = date.toLocaleString(); let sc = 'status-pending', st = (item.status || 'pending').toLowerCase(); if (st === 'approved') sc = 'status-approved'; else if (st === 'rejected') sc = 'status-rejected'; div.innerHTML = `<div class="details"><span>Amt: ${item.pkrAmount||'?'} PKR (${item.withdrawalAmountCoins||'?'} C)</span><span>Method: ${item.paymentMethod||'N/A'}</span><span>Acc: ${item.accountNumber||'N/A'} (${item.accountHolderName||'N/A'})</span></div><div class="status ${sc}">${st.toUpperCase()}</div><div class="date">${fmtDate}</div>`; historyListDiv.appendChild(div); }); } else { historyListDiv.innerHTML = '<p class="no-history">No history found.</p>'; } } catch (e) { console.error("History err:", e); historyListDiv.innerHTML = '<p class="no-history" style="color: red;">Error loading.</p>'; } }

    // --- Invite Logic ---
    const baseInviteUrl = window.location.origin + window.location.pathname;
    function generateRandomCode() { return Math.random().toString(36).substring(2, 8).toUpperCase(); }
    async function redeemInviteCode(code, uid = null, data = null) { const userId = uid || auth.currentUser?.uid; if (!userId) throw new Error("Log in to redeem."); if (!code) throw new Error("Enter code."); code = code.trim().toUpperCase(); if (currentUserInviteCode && code === currentUserInviteCode) throw new Error("Cannot redeem own code."); let userData = data; if (!userData) { const s = await get(ref(db, `users/${userId}`)); if (!s.exists()) throw new Error("User data not found."); userData = s.val(); } if (userData.referralRedeemed) throw new Error("Code already redeemed."); const q = query(ref(db, "users"), orderByChild("inviteCode"), equalTo(code)); const s = await get(q); if (!s.exists()) throw new Error("Invalid code."); let refId = null, refData = null; s.forEach(cs => { if (cs.key !== userId) { refId = cs.key; refData = cs.val(); } }); if (!refId || !refData) throw new Error("Invalid code or own code."); if (refData.inviteCode?.toUpperCase() !== code) throw new Error("Code mismatch."); const refCount = refData.referralCount || 0; const rBonus = 200, fBonus = 100; const curCoins = (userData.totalCoins || 0) + fBonus; const refCoins = (refData.totalCoins || 0) + rBonus; console.log(`Redeem: Referrer=${refId}, Current=${userId}. User +${fBonus}, Referrer +${rBonus}`); await Promise.all([set(ref(db, `users/${userId}/totalCoins`), curCoins), set(ref(db, `users/${userId}/referralRedeemed`), true), set(ref(db, `users/${refId}/totalCoins`), refCoins), set(ref(db, `users/${refId}/referralCount`), refCount + 1)]); return { newCoins: curCoins, rBonus: rBonus, fBonus: fBonus }; }
    inviteFriendBtn.addEventListener("click", () => { if (!auth.currentUser) { showStatusMessage("Log in for invites.", "error"); return; } loadUserData(); inviteModal.style.display = "block"; });
    closeInviteModal.addEventListener("click", () => { inviteModal.style.display = "none"; });
    copyInviteCode.addEventListener("click", () => { if(currentUserInviteCode && !["Loading...","N/A (Guest)","Error"].includes(currentUserInviteCode)){ const link = `${baseInviteUrl}?ref=${currentUserInviteCode}`; navigator.clipboard.writeText(link).then(()=>showStatusMessage("Invite link copied!", "success")).catch(err=>{showStatusMessage("Copy failed.", "error");console.error('Copy err:',err);}); }else{showStatusMessage("Invite link unavailable.", "error");} });
    redeemCodeBtn.addEventListener("click", async () => { const code = redeemCodeInput.value; if (!code) { showStatusMessage("Enter code.", "error"); return; } if (!auth.currentUser) { showStatusMessage("Log in first.", "error"); return; } try { const { newCoins, rBonus, fBonus } = await redeemInviteCode(code); totalCoins = newCoins; loadUserData(); showStatusMessage(`Code redeemed! You +${fBonus}, Friend +${rBonus}.`, "success", 4000); inviteModal.style.display = "none"; redeemCodeInput.value = ""; } catch (e) { console.error("Redeem err:", e); showStatusMessage("Error: " + e.message, "error"); } });

    // --- Withdraw Logic ---
    let selectedWithdrawCoins = 0; let selectedWithdrawPKR = 0;
    withdrawBtn.addEventListener("click", () => { if(!auth.currentUser){showStatusMessage("Log in to withdraw.", "error");return;} loadUserData(); redeemOptionsDiv.style.display="block"; redeemFormDiv.style.display="none"; redeemDetailsForm.reset(); redeemSubmitBtn.disabled=false; redeemSubmitBtn.textContent="Submit Request"; withdrawModal.style.display="block"; });
    closeWithdraw.addEventListener("click", () => { withdrawModal.style.display = "none"; });
    redeemOptionsDiv.querySelectorAll('.redeem-option').forEach(b => { b.addEventListener('click', () => { selectedWithdrawCoins=parseInt(b.dataset.coins,10); selectedWithdrawPKR=parseInt(b.dataset.pkr,10); if(totalCoins < selectedWithdrawCoins){ showStatusMessage(`Need ${selectedWithdrawCoins} coins. Have ${totalCoins}.`, "error"); return; } redeemOptionsDiv.style.display='none'; redeemFormDiv.style.display='block'; }); });
    redeemDetailsForm.addEventListener('submit', (e) => { e.preventDefault(); const name=accountHolderName.value.trim(); const num=accountNumber.value.trim(); const methodInput=document.querySelector('input[name="paymentMethod"]:checked'); if(!name || !num || !methodInput){ showStatusMessage("Fill fields & select method.", "error"); return; } if(totalCoins < selectedWithdrawCoins){ showStatusMessage(`Need ${selectedWithdrawCoins} coins.`, "error"); withdrawModal.style.display = "none"; return; } const user=auth.currentUser; if(!user){ showStatusMessage("Auth error. Log in again.", "error"); withdrawModal.style.display="none"; return; } const method=methodInput.value; const reqData={ uid: user.uid, email: user.email||"?", username: currentUsername||user.email, withdrawalAmountCoins: selectedWithdrawCoins, pkrAmount: selectedWithdrawPKR, accountHolderName: name, accountNumber: num, paymentMethod: method, status: "pending", timestamp: Date.now() }; redeemSubmitBtn.disabled=true; redeemSubmitBtn.textContent="Submitting..."; push(ref(db,"withdrawRequests"), reqData).then(async (reqRef)=>{ console.log("Withdraw request OK:", reqRef.key); const newTotal = totalCoins - selectedWithdrawCoins; await set(ref(db,"users/"+user.uid+"/totalCoins"), newTotal); return newTotal; }).then((newTotal)=>{ console.log("Coins updated."); totalCoins = newTotal; menuCoinCountSpan.innerText = totalCoins; finalTotalCoinsSpan.innerText = totalCoins; showStatusMessage(`Withdrawal for ${selectedWithdrawPKR} PKR submitted! Pending approval.`, "success", 5000); withdrawModal.style.display = "none"; }).catch(err=>{ showStatusMessage("Submit error: "+err.message, "error"); console.error("Withdraw err:", err); redeemSubmitBtn.disabled=false; redeemSubmitBtn.textContent="Submit Request"; }); });

    // --- Info Modal ---
    infoBtn.addEventListener("click", () => { infoModal.style.display = "block"; });
    closeInfo.addEventListener("click", () => { infoModal.style.display = "none"; });

    // --- Logout ---
    logoutBtn.addEventListener("click", () => { signOut(auth).then(() => { showStatusMessage("Logged out.", "info"); }).catch((e) => { showStatusMessage("Logout error: "+e.message, "error"); }); });

    // --- Game Engine ---
    const ctx = gameCanvas.getContext("2d");
    function resizeCanvas() { gameCanvas.width=window.innerWidth; const bannerH=document.getElementById('bannerAdContainer')?.offsetHeight||50; gameCanvas.height=window.innerHeight-bannerH; if(gameStarted && mario){ const groundY=gameCanvas.height-50; if(mario.y+mario.height >= groundY-5 || !mario.isJumping){ mario.y = groundY - mario.height; mario.dy = 0; mario.isJumping=false; canDoubleJump=false; } } }
    window.addEventListener("resize", resizeCanvas);
    const imagesToLoad = { character:"https://i.imgur.com/AbfH2aB.png",background:"https://i.imgur.com/xZpZqGt.png",enemy:"https://i.imgur.com/TsR4WXH.png",coin:"https://i.imgur.com/cMQ9X0d.png",platform:"https://i.imgur.com/06ptzal.png"};
    const gameImages = {}; let imagesLoadedCount = 0; let totalImagesToLoad = Object.keys(imagesToLoad).length;
    function checkAllImagesLoaded() { imagesLoadedCount++; if (imagesLoadedCount === totalImagesToLoad) { allImagesLoaded = true; console.log("All images loaded."); } }
    for (const key in imagesToLoad) { gameImages[key] = new Image(); gameImages[key].onload = checkAllImagesLoaded; gameImages[key].onerror = () => { console.error("Image load fail:", key); totalImagesToLoad--; }; gameImages[key].src = imagesToLoad[key]; }
    function initGame() { if (!allImagesLoaded) { showStatusMessage("Assets loading...", "info"); return; } console.log("Init game..."); resizeCanvas(); bgX=0; platformX=0; const groundY=gameCanvas.height-50; mario={x:60,y:groundY-60,width:40,height:60,dy:0,gravity:1.6,jumpPower:-22,doubleJumpPower:-18,isJumping:false}; obstacles=[]; coins=[]; speed=6; score=0; gameOver=false; gameStarted=true; lastJumpInputTime=0; canDoubleJump=false; if(animationFrameId) cancelAnimationFrame(animationFrameId); playBackgroundMusic(); gameLoop(); }
    function drawBackground() { if (!gameImages.background?.complete) return; bgX=(bgX-speed*0.4)%gameImages.background.width; ctx.drawImage(gameImages.background,bgX,0,gameImages.background.width,gameCanvas.height); ctx.drawImage(gameImages.background,bgX+gameImages.background.width,0,gameImages.background.width,gameCanvas.height); }
    function drawPlatform() { if (!gameImages.platform?.complete) return; const groundY=gameCanvas.height-50; platformX=(platformX-speed)%gameImages.platform.width; ctx.drawImage(gameImages.platform,platformX,groundY,gameImages.platform.width,50); ctx.drawImage(gameImages.platform,platformX+gameImages.platform.width,groundY,gameImages.platform.width,50); }
    function drawMario() { if(!mario||!gameImages.character?.complete) return; ctx.drawImage(gameImages.character,mario.x,mario.y,mario.width,mario.height); }
    function drawObstacles() { if (!gameImages.enemy?.complete) return; for (let i=obstacles.length-1;i>=0;i--){ let obs=obstacles[i]; obs.x-=speed; ctx.drawImage(gameImages.enemy,obs.x,obs.y,obs.width,obs.height); if(obs.x+obs.width<0)obstacles.splice(i,1); }}
    function spawnObstacles() { if(gameOver||!gameImages.enemy?.complete) return; const baseMin=350,baseMax=650,diff=Math.max(0.1,1-(score/800)); const curMin=baseMin*diff,curMax=baseMax*diff; const range=Math.max(50,curMax-curMin); const dist=curMin+Math.random()*range; let lastX=obstacles.length>0?obstacles[obstacles.length-1].x:-dist; if(gameCanvas.width-lastX>dist&&obstacles.length<5){ const groundY=gameCanvas.height-50; obstacles.push({x:gameCanvas.width+10,y:groundY-50,width:50,height:50}); } }
    function spawnCoins() { if(!gameImages.coin?.complete||gameOver) return; const chance=0.025; if(coins.length<25&&Math.random()<chance){ const groundY=gameCanvas.height-50; let startY=groundY-30; if(Math.random()<0.4)startY=groundY-80-(Math.random()*60); let count=Math.floor(Math.random()*4)+2; let startX=gameCanvas.width+Math.random()*100; const spacing=45; for(let i=0;i<count;i++) coins.push({x:startX+i*spacing,y:startY,width:25,height:25}); } }
    function drawCoins() { if (!gameImages.coin?.complete||!mario||gameOver) return; const user=auth.currentUser; for (let i=coins.length-1;i>=0;i--) { let c=coins[i]; c.x-=speed; ctx.drawImage(gameImages.coin, c.x-c.width/2, c.y-c.height/2, c.width, c.height); if (mario.x<c.x+c.width/2 && mario.x+mario.width>c.x-c.width/2 && mario.y<c.y+c.height/2 && mario.y+mario.height>c.y-c.height/2 ) { coins.splice(i, 1); score += 1; playSound(coinSound); if (user) totalCoins += 1; } else if (c.x+c.width<0) { coins.splice(i, 1); } } }
    function applyPhysics() { if(!mario||gameOver) return; mario.dy+=mario.gravity; mario.y+=mario.dy; const groundY=gameCanvas.height-50; if(mario.y+mario.height>=groundY){ mario.y=groundY-mario.height; mario.dy=0; if(mario.isJumping){ mario.isJumping=false; canDoubleJump=false; }} if(mario.y<0){ mario.y=0; mario.dy=0; } }
    function checkCollision() { if(!mario||gameOver) return; for(let i=obstacles.length-1;i>=0;i--){ let obs=obstacles[i]; if(mario.x<obs.x+obs.width&&mario.x+mario.width>obs.x&&mario.y<obs.y+obs.height&&mario.y+mario.height>obs.y){ console.log("Collision!"); gameOver=true; stopBackgroundMusic(); playSound(gameOverSound); break; } } }
    function jump() { if(!gameStarted||gameOver||!mario) return; const now=Date.now(); const groundY=gameCanvas.height-50; const onGround=mario.y+mario.height>=groundY-5; let jumped=false; if(mario.isJumping&&canDoubleJump&&(now-lastJumpInputTime<doubleJumpWindow)){ mario.dy=mario.doubleJumpPower; canDoubleJump=false; lastJumpInputTime=0; console.log("Double Jump!"); jumped=true; } else if(onGround){ mario.dy=mario.jumpPower; mario.isJumping=true; canDoubleJump=true; lastJumpInputTime=now; console.log("First Jump!"); jumped=true; } if(jumped) playSound(jumpSound); }
    function gameLoop() { if(gameOver||!gameStarted){ if(gameOver) handleGameOver(); return; } applyPhysics(); checkCollision(); if(gameOver){ handleGameOver(); return; } spawnObstacles(); spawnCoins(); ctx.clearRect(0,0,gameCanvas.width,gameCanvas.height); drawBackground(); drawPlatform(); drawObstacles(); drawCoins(); drawMario(); ctx.fillStyle="#FFF"; ctx.font="20px 'Press Start 2P'"; ctx.textAlign="left"; ctx.textBaseline="top"; ctx.shadowColor='black'; ctx.shadowBlur=4; ctx.shadowOffsetX=2; ctx.shadowOffsetY=2; ctx.fillText("Score: "+score, 20, 20); if (auth.currentUser) ctx.fillText("Total Coins: "+totalCoins, 20, 50); ctx.shadowBlur=0; ctx.shadowOffsetX=0; ctx.shadowOffsetY=0; animationFrameId=requestAnimationFrame(gameLoop); }
    function handleGameOver() { console.log("Game Over. Score:", score); gameStarted=false; const user=auth.currentUser; if(animationFrameId){ cancelAnimationFrame(animationFrameId); animationFrameId=null; } restartAttempts=0; console.log("Restart attempts reset."); if (user && score > 0) { console.log(`Saving coins (${totalCoins}) for ${user.uid}`); set(ref(db,"users/"+user.uid+"/totalCoins"), totalCoins).then(()=>console.log("Coins saved.")).catch(e=>{console.error("Coin save err:",e);showStatusMessage("Error saving coins.","error");}); } else if (user && score === 0) { console.log("Score 0, no save needed."); } else { console.log("Guest game over."); } sessionCoinCountSpan.innerText = score; finalTotalCoinsSpan.innerText = totalCoins; showGameOverMenu(); }

    // --- Game Control Buttons ---
    const startBtn = document.getElementById('startBtn');
    const restartBtn = document.getElementById('restartBtn');
    const backMenuBtn = document.getElementById('backMenuBtn');
    startBtn.addEventListener("click", () => { if (!allImagesLoaded) { showStatusMessage("Assets loading...", "info"); return; } showInterstitialAd(() => { console.log("Ad callback: Init game."); mainMenu.style.display = "none"; gameCanvas.style.display = 'block'; initGame(); }); });
    restartBtn.addEventListener("click", () => { if (!allImagesLoaded) { showStatusMessage("Assets error.", "error"); showMainMenu(); return; } restartAttempts++; console.log(`Restart attempt: ${restartAttempts}`); const restart=()=>{ console.log("Restarting."); gameOverMenu.style.display="none"; gameCanvas.style.display='block'; initGame(); }; if (restartAttempts >= 3) { showInterstitialAd(() => { console.log("Ad callback: Restarting."); restart(); }); } else { restart(); } });
    backMenuBtn.addEventListener("click", showMainMenu);

    // --- Jump Listeners ---
    document.addEventListener("keydown", (e) => { if ((e.code === "Space" || e.code === "ArrowUp") && gameStarted && !gameOver) { e.preventDefault(); jump(); } });
    gameCanvas.addEventListener("click", (e) => { if (gameStarted && !gameOver) { e.preventDefault(); jump(); } });
    gameCanvas.addEventListener("touchstart", (e) => { if (gameStarted && !gameOver) { e.preventDefault(); jump(); } }, { passive: false });

    // --- Initial Setup ---
    console.log("Initial setup...");
    mainMenu.style.display = "none"; gameCanvas.style.display = "none"; gameOverMenu.style.display = "none";
    signupPanel.style.display = "none"; loginPanel.style.display = "flex"; // Default to login panel
    setAuthProcessing(false); // Ensure buttons enabled
    updateSoundButton(); checkUrlForReferral();
    console.log("Setup complete. Waiting for user interaction or auth state change.");

  </script>
</body>
</html>