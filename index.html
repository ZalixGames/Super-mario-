<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mario Run â€“ Ultimate Gamer Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <script type='text/javascript' src='//pl26412649.profitableratecpm.com/13/e5/a4/13e5a43804eecf191c995f63cff90d9c.js'></script>
  <style>
    /* --- Previous CSS Styles remain the same --- */
    /* Basic Reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Press Start 2P', cursive; overflow: hidden;
      background: #0a0a0a url('https://www.transparenttextures.com/patterns/stardust.png');
      color: #fff; margin-bottom: 50px; /* Space for banner */
    }
    canvas { display: block; }
    .text-glow { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #ff007f; }
    .box-glow { box-shadow: 0 0 8px rgba(255, 255, 255, 0.6), 0 0 15px rgba(255, 0, 127, 0.5); }
    .game-btn {
      padding: 12px 25px; margin: 10px; font-size: 14px; border: none;
      border-radius: 8px; cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
      background: linear-gradient(145deg, #ff4757, #ff6348); color: #fff;
      font-family: 'Press Start 2P', cursive; text-transform: uppercase;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7); border-bottom: 4px solid #c0392b;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); display: inline-flex;
      align-items: center; justify-content: center; line-height: 1.2;
    }
    .game-btn:hover {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 100, 100, 0.6);
      background: linear-gradient(145deg, #ff6348, #ff7f50);
    }
    .game-btn:active { transform: translateY(1px) scale(1); border-bottom-width: 2px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
    #loginPanel {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: url('https://i.imgur.com/nxRZ03R.png') no-repeat center center; background-size: cover;
      z-index: 100; flex-direction: column; justify-content: center; align-items: center;
      color: #fff; padding: 20px; text-align: center; background-color: rgba(0,0,0,0.5);
    }
    #loginPanel h2 { font-size: 2.5em; color: #ff007f; margin-bottom: 30px; text-shadow: 3px 3px 0px #000, 0 0 15px #ff007f; }
    #loginPanel input {
      width: 250px; padding: 12px 15px; margin: 8px; background: rgba(10, 10, 10, 0.8);
      border: 2px solid #ff007f; color: #fff; border-radius: 5px; font-family: 'Press Start 2P', cursive;
      font-size: 14px; outline: none; transition: border-color 0.3s, box-shadow 0.3s;
    }
    #loginPanel input:focus { border-color: #ff60af; box-shadow: 0 0 10px rgba(255, 0, 127, 0.7); }
    #loginPanel button { width: 180px; background: linear-gradient(145deg, #ff007f, #e60073); border-bottom-color: #a70057; }
    #loginPanel button:hover { background: linear-gradient(145deg, #e60073, #ff309f); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 0, 127, 0.6); }
    #mainMenu {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: url('https://i.imgur.com/KFWJlte.png') no-repeat center center; background-size: cover;
      z-index: 30; display: none; flex-direction: column; justify-content: center; align-items: center;
      color: #fff; padding: 20px; text-align: center;
    }
    #mainMenu h1 { font-size: 3.5em; text-shadow: 4px 4px 0px rgba(0,0,0,0.8), 0 0 20px rgba(255,255,255,0.5); margin-bottom: 40px; color: #ffe64d; }
    #topRightStatus {
      position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.85); padding: 10px 15px;
      border-radius: 8px; font-size: 18px; color: #FFD700; z-index: 35; border: 2px solid #FFD700;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); display: inline-flex; align-items: center;
    }
    #topRightStatus img#coinIcon { width: 24px; height: 24px; margin-right: 8px; vertical-align: middle; }
    #settingsBtn {
      position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.8); border: 2px solid #ccc;
      border-radius: 50%; cursor: pointer; z-index: 35; width: 45px; height: 45px; display: flex;
      justify-content: center; align-items: center; transition: transform 0.2s, box-shadow 0.2s;
    }
    #settingsBtn svg { width: 24px; height: 24px; fill: #fff; }
    #settingsBtn:hover { transform: rotate(45deg) scale(1.1); box-shadow: 0 0 15px rgba(255,255,255,0.7); border-color: #fff; }
    #mainMenu .menu-btn { width: 220px; }
    #mainMenu #withdrawBtn { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; }
    #mainMenu #withdrawBtn:hover { background: linear-gradient(145deg, #1dd1a1, #00b894); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(46, 213, 115, 0.6); }
    #mainMenu #inviteFriend { background: linear-gradient(145deg, #54a0ff, #2e86de); border-bottom-color: #1e5ea8; }
    #mainMenu #inviteFriend:hover { background: linear-gradient(145deg, #2e86de, #1e66b0); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(84, 160, 255, 0.6); }
    #mainMenu #logoutBtn { background: linear-gradient(145deg, #8395a7, #576574); border-bottom-color: #2f3640; }
    #mainMenu #logoutBtn:hover { background: linear-gradient(145deg, #576574, #434c58); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 15px rgba(131, 149, 167, 0.6); }
    #gameOverMenu {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8);
      z-index: 40; display: none; flex-direction: column; justify-content: center; align-items: center;
      color: #ff4757; padding: 20px; text-align: center;
    }
    #gameOverMenu h2 { font-size: 4em; text-shadow: 4px 4px 0px #000, 0 0 20px #ff0000; margin-bottom: 20px; }
    #gameOverMenu p { font-size: 1.5em; color: #fff; margin-bottom: 10px; text-shadow: 1px 1px 2px #000; }
    #gameOverMenu .menu-btn { width: 200px; }
    #gameOverMenu #restartBtn { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; }
    #gameOverMenu #backMenuBtn { background: linear-gradient(145deg, #54a0ff, #2e86de); border-bottom-color: #1e5ea8; }
    .modal {
      display: none; position: fixed; z-index: 70; left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
    }
    .modal .modal-content {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e1e1e;
      padding: 20px 25px; border-radius: 10px; width: 90%; max-width: 360px; color: #eee;
      text-align: center; font-family: 'Press Start 2P', cursive; border: 3px solid #ff007f;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5), 0 0 15px rgba(255, 0, 127, 0.4);
    }
    .modal h2 { margin-bottom: 20px; font-size: 1.4em; color: #ff007f; text-shadow: 1px 1px 2px #000; }
    .modal button.game-btn { width: 100%; margin: 8px 0; padding: 10px 15px; font-size: 12px; }
    .modal input[type="text"], .modal input[type="email"], .modal input[type="password"] {
      width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 15px; border: 2px solid #555;
      border-radius: 5px; background: #333; color: #fff; font-family: 'Arial', sans-serif;
      font-size: 16px; outline: none; transition: border-color 0.3s, box-shadow 0.3s;
    }
    .modal input:focus { border-color: #ff007f; box-shadow: 0 0 8px rgba(255, 0, 127, 0.6); }
    .close-btn {
      position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 28px;
      cursor: pointer; color: #aaa; font-family: Arial, sans-serif; transition: color 0.2s, transform 0.2s; font-weight: bold;
    }
    .close-btn:hover { color: #ff007f; transform: scale(1.2); }
    #settingsModal .modal-content { max-width: 300px; }
    #inviteModal .modal-content { max-width: 360px; }
    #withdrawModal .modal-content { max-width: 380px; }
    #infoModal .modal-content { max-width: 360px; }
    #toggleSound { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; }
    #customerService { background: linear-gradient(145deg, #54a0ff, #2e86de); border-bottom-color: #1e5ea8; }
    #toggleSound:hover { background: linear-gradient(145deg, #1dd1a1, #00b894); }
    #customerService:hover { background: linear-gradient(145deg, #2e86de, #1e66b0); }
    #inviteModal .section { margin: 20px 0; border-top: 1px solid #444; padding-top: 15px; }
    #inviteModal .section h3 { font-size: 1.1em; margin-bottom: 10px; color: #eee; }
    #inviteModal .section p { font-size: 1em; margin-bottom: 12px; font-family: Arial, sans-serif; }
    #yourInviteCode { font-size: 1.2em; color: #FFD700; background: #333; padding: 8px 12px; border-radius: 5px; display: inline-block; border: 1px solid #555; word-break: break-all; }
    #copyInviteCode { background: linear-gradient(145deg, #feca57, #ff9f43); border-bottom-color: #e67e22; }
    #redeemCodeBtn { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; }
    #copyInviteCode:hover { background: linear-gradient(145deg, #ff9f43, #f39c12); }
    #redeemCodeBtn:hover { background: linear-gradient(145deg, #1dd1a1, #00b894); }
    #withdrawModal .modal-content p { margin-bottom: 20px; font-family: Arial, sans-serif; line-height: 1.5; }
    #withdrawModal .redeem-option {
      background: linear-gradient(145deg, #1abc9c, #16a085); border-bottom: 4px solid #117a65; color: #fff;
      padding: 10px 15px; margin: 6px 0; border-radius: 8px; font-size: 13px; text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease; width: 100%; display: flex;
      align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2);
    }
    #withdrawModal .redeem-option:hover { background: linear-gradient(145deg, #1dd1a1, #1abc9c); transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3), 0 0 15px rgba(26, 188, 156, 0.5); }
    #withdrawModal .redeem-option:active { transform: translateY(1px); border-bottom-width: 2px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
    #redeemForm { display: none; margin-top: 20px; font-family: Arial, sans-serif; font-size: 16px; line-height: 1.5; text-align: left; }
    #redeemForm h3 { font-family: 'Press Start 2P', cursive; font-size: 1.2em; color: #eee; margin-bottom: 15px; text-align: center; }
    #redeemForm label { display: block; margin-bottom: 5px; color: #ccc; font-size: 14px; }
    #redeemForm input[type="text"] { margin-bottom: 15px; }
    #redeemForm input[type="radio"] { margin-right: 8px; vertical-align: middle; }
    #redeemForm label input[type="radio"] { display: inline; margin-bottom: 0; }
    #redeemForm .payment-options label { margin-bottom: 10px; display: block;}
    #redeemSubmitBtn { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; width: 100%; margin-top: 20px; font-size: 14px; }
    #redeemSubmitBtn:hover { background: linear-gradient(145deg, #1dd1a1, #00b894); }
    #redeemSubmitBtn:disabled { background: #555; cursor: not-allowed; border-bottom-color: #333; }
    #infoModal .modal-content h2 { color: #54a0ff; }
    #infoModal .modal-content p { margin: 15px 0; font-family: Arial, sans-serif; font-size: 15px; line-height: 1.6; color: #ddd; text-align: left; }
    #infoModal .modal-content p strong { color: #fff; }
    #bannerAdContainer {
      position: fixed; bottom: 0; left: 0; width: 100%; height: 50px; background-color: #000;
      z-index: 1000; display: flex; justify-content: center; align-items: center; overflow: hidden; border-top: 2px solid #333;
    }
    #bannerAdContainer iframe { max-width: 100%; }
    #interstitialAdOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9);
      z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center;
      color: white; text-align: center; font-family: 'Press Start 2P', cursive; padding: 20px; backdrop-filter: blur(3px);
    }
    #interstitialAdOverlay p#adInfoText { font-size: 1.1em; margin-bottom: 25px; color: #eee; line-height: 1.5; }
    #interstitialAdCloseButton { padding: 12px 25px; font-size: 1em; cursor: pointer; background: linear-gradient(145deg, #ff4757, #e84118); border-bottom-color: #c23616; color: white; border-radius: 8px; font-family: 'Press Start 2P', cursive; display: none; text-transform: uppercase; margin-top: 20px; }
    #interstitialAdCloseButton:hover { background: linear-gradient(145deg, #e84118, #d63031); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 71, 87, 0.6); }
    #interstitialAdTimer { margin-top: 15px; font-size: 0.9em; color: #ccc; }
    #interstitialAdOverlay p.skip-info { font-size: 0.8em; color: #aaa; margin-top: 30px; font-family: Arial, sans-serif; line-height: 1.4; }
    /* --- End of CSS --- */
  </style>
</head>
<body>
  <!-- Audio Elements -->
  <!-- MODIFIED: Removed autoplay from background audio -->
  <audio id="backgroundAudio" loop>
    <source src="mines background .mp3" type="audio/mp3">
    Your browser does not support the audio element.
  </audio>
  <!-- ADD YOUR SOUND EFFECT FILES HERE -->
  <audio id="jumpSound">
    <source src="gruntjumpland-101soundboards.mp3" type="audio/mp3"> <!-- Replace with your jump sound file -->
  </audio>
  <audio id="coinSound">
    <source src="coin-recieved-230517.mp3" type="audio/mp3"> <!-- Replace with your coin sound file -->
  </audio>
  <audio id="gameOverSound">
    <source src="game-over-arcade-6435.mp3" type="audio/mp3"> <!-- Replace with your game over sound file -->
  </audio>
  <!-- End Audio Elements -->


  <!-- ---------- Login Panel ---------- -->
  <div id="loginPanel" style="display: flex;"> <!-- Default to flex to show initially -->
    <h2>Gamer Login</h2>
    <input type="email" id="loginEmail" placeholder="Email" />
    <input type="password" id="loginPassword" placeholder="Password" />
    <button id="loginButton" class="game-btn">Login</button>
    <button id="signupButton" class="game-btn">Sign Up</button>
    <button id="guestButton" class="game-btn">Continue Guest</button>
  </div>

  <!-- Game Canvas -->
  <canvas id="gameCanvas" style="display: none;"></canvas>

  <!-- ---------- Main Menu ---------- -->
  <div id="mainMenu" style="display: none;">
    <button id="settingsBtn" title="Open Settings">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M487.4 315.7l-42.1-24.3c2.8-12.8 4.3-26 4.3-39.4s-1.5-26.6-4.3-39.4l42.1-24.3c9.4-5.4 13.3-17.1 9.4-27.2l-45.3-78.4c-3.9-10.1-14.2-14.8-24.7-11.5l-49.5 19.9c-20.5-16.1-43-29.2-67.2-38.1l-7.5-52.8C309 3.7 300.3-2.5 290.3.1l-90.6 18.5c-10 2.1-17.6 9.9-19.8 19.8l-7.5 52.8c-24.3 8.9-46.8 22-67.2 38.1L54.6 83.1c-10.5-3.3-20.8.4-24.7 11.5L-15.4 172.9c-3.9 10.1-.1 21.8 9.4 27.2l42.1 24.3C73.5 243.3 72 256.4 72 269.9c0 13.5 1.5 26.6 4.3 39.4l-42.1 24.3c-9.4 5.4-13.3 17.1-9.4 27.2l45.3 78.4c3.9 10.1 14.2 14.8 24.7 11.5l49.5-19.9c20.5 16.1 43 29.2 67.2 38.1l7.5 52.8c2 10 10.7 15.3 20.7 12.8l90.6-18.5c10-2.1 17.6-9.9 19.8-19.8l7.5-52.8c24.3-8.9 46.8-22 67.2-38.1l49.5 19.9c10.5 3.3 20.8-.4 24.7-11.5l45.3-78.4c3.9-10.1.1-21.8-9.4-27.2zM256 336c-44.2 0-80-35.8-80-80s35.8-80 80-80c44.2 0 80 35.8 80 80s-35.8 80-80 80z"></path></svg>
    </button>
    <div id="topRightStatus">
      <img id="coinIcon" src="https://i.imgur.com/PCDgdlS.png" alt="Coin">
      Coins: <span id="menuCoinCount">0</span>
    </div>
    <h1>Mario Run</h1>
    <button id="startBtn" class="menu-btn game-btn">Play Now</button>
    <button id="withdrawBtn" class="menu-btn game-btn">Withdraw Coins</button>
    <button id="inviteFriend" class="menu-btn game-btn">Invite (0 Refs)</button>
    <button id="infoBtn" class="menu-btn game-btn">Game Info</button>
    <button id="logoutBtn" class="menu-btn game-btn">Exit Game</button>
  </div>

  <!-- ---------- Settings Modal ---------- -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeSettings">Ã—</button>
      <h2>Settings</h2>
      <button id="toggleSound" class="game-btn">Sound: On</button>
      <button id="customerService" class="game-btn">Customer Service</button>
    </div>
  </div>

  <!-- ---------- Invite Modal ---------- -->
  <div id="inviteModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeInviteModal">Ã—</button>
      <h2>Invite Friend</h2>
      <div class="section">
        <h3>Your Invite Link</h3>
        <p id="yourInviteCode">Loading...</p>
        <button id="copyInviteCode" class="game-btn">Copy Link</button>
      </div>
      <div class="section">
        <h3>Redeem Invite Code</h3>
        <input type="text" id="redeemCodeInput" placeholder="Enter friend's code" />
        <button id="redeemCodeBtn" class="game-btn">Redeem</button>
      </div>
    </div>
  </div>

  <!-- ---------- Game Over Overlay ---------- -->
  <div id="gameOverMenu" style="display: none;">
    <h2>Game Over</h2>
    <p>Session Coins: <span id="sessionCoinCount">0</span></p>
    <p>Total Coins: <span id="finalTotalCoins">0</span></p>
    <button id="restartBtn" class="menu-btn game-btn">Restart</button>
    <button id="backMenuBtn" class="menu-btn game-btn">Back to Menu</button>
  </div>

  <!-- ---------- Withdraw Modal ---------- -->
  <div id="withdrawModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeWithdraw">Ã—</button>
      <h2>Redeem Coins</h2>
      <p>Select an option to redeem your coins:</p>
      <div id="redeemOptions">
        <button class="redeem-option" data-coins="10000" data-pkr="100">10000 Coins - 100 PKR</button>
        <button class="redeem-option" data-coins="30000" data-pkr="300">30000 Coins - 300 PKR</button>
        <button class="redeem-option" data-coins="50000" data-pkr="500">50000 Coins - 500 PKR</button>
        <button class="redeem-option" data-coins="80000" data-pkr="800">80,000 Coins - 800 PKR</button>
        <button class="redeem-option" data-coins="100000" data-pkr="1000">100,000 Coins - 1000 PKR</button>
        <button class="redeem-option" data-coins="500000" data-pkr="5000">500,000 Coins - 5000 PKR</button>
      </div>
      <div id="redeemForm" style="display: none;">
        <h3>Enter Your Details</h3>
        <form id="redeemDetailsForm">
          <div><label for="accountHolderName">Account Holder Name:</label><input type="text" id="accountHolderName" required /></div>
          <div><label for="accountNumber">Account Number:</label><input type="text" id="accountNumber" required /></div>
          <div class="payment-options" style="margin-top: 15px;">
            <label>Select Payment Method:</label>
            <label><input type="radio" name="paymentMethod" value="JazzCash" required> JazzCash</label>
            <label><input type="radio" name="paymentMethod" value="EasyPaisa" required> EasyPaisa</label>
          </div>
          <button type="submit" id="redeemSubmitBtn" class="game-btn">Submit Request</button>
        </form>
      </div>
    </div>
  </div>

  <!-- ---------- Game Info Modal ---------- -->
  <div id="infoModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeInfo">Ã—</button>
      <h2>Game Info</h2>
      <p>Welcome to <strong>Mario Run â€“ Ultimate Gamer Edition</strong>. Enjoy endless fun and earn coins while you play!</p>
      <p><strong>Online Play:</strong> Log in or sign up to save your coins. Earned coins can be redeemed for rewards!</p>
      <p><strong>Offline Play (Guest):</strong> Play for fun! Coins earned as a guest are not saved and cannot be redeemed.</p>
      <p><strong>Invite Friends:</strong> Share your invite link. You and your friend both earn bonus coins when they redeem your code!</p>
    </div>
  </div>

  <!-- --- AD INTEGRATION START --- -->
  <div id="bannerAdContainer">
    <script type="text/javascript"> atOptions = {'key' : '84c9a4eabdeffe242051226bdf854fd8', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {}}; </script>
    <script type="text/javascript" src="//www.highperformanceformat.com/84c9a4eabdeffe242051226bdf854fd8/invoke.js"></script>
  </div>
  <div id="interstitialAdOverlay" style="display: none;">
      <p id="adInfoText">Advertisement loading...</p>
      <div id="interstitialAdTimer"></div>
      <button id="interstitialAdCloseButton" class="game-btn" style="display: none;">Skip Ad</button>
      <p class="skip-info">(Click 'Skip Ad' to return. You may need to close the ad tab manually.)</p>
  </div>
  <!-- --- AD INTEGRATION END --- -->


  <!-- Firebase and Game Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
    import { getDatabase, ref, set, get, push, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";

    // --- DOM Element References ---
    const loginPanel = document.getElementById('loginPanel');
    const mainMenu = document.getElementById('mainMenu');
    const gameOverMenu = document.getElementById('gameOverMenu');
    const gameCanvas = document.getElementById('gameCanvas');
    const settingsModal = document.getElementById('settingsModal');
    const inviteModal = document.getElementById('inviteModal');
    const withdrawModal = document.getElementById('withdrawModal');
    const infoModal = document.getElementById('infoModal');
    const interstitialAdOverlay = document.getElementById('interstitialAdOverlay');
    const interstitialAdCloseButton = document.getElementById('interstitialAdCloseButton');
    const interstitialAdTimer = document.getElementById('interstitialAdTimer');
    const adInfoText = document.getElementById('adInfoText');
    const menuCoinCountSpan = document.getElementById('menuCoinCount');
    const finalTotalCoinsSpan = document.getElementById('finalTotalCoins');
    const sessionCoinCountSpan = document.getElementById('sessionCoinCount');
    const inviteFriendBtn = document.getElementById('inviteFriend');
    const yourInviteCodeP = document.getElementById('yourInviteCode');
    const redeemCodeInput = document.getElementById("redeemCodeInput");
    const toggleSoundBtn = document.getElementById("toggleSound");
    const redeemOptionsDiv = document.getElementById("redeemOptions");
    const redeemFormDiv = document.getElementById("redeemForm");
    const redeemDetailsForm = document.getElementById("redeemDetailsForm");
    const redeemSubmitBtn = document.getElementById('redeemSubmitBtn');
    // Audio Elements
    const backgroundAudio = document.getElementById("backgroundAudio");
    const jumpSound = document.getElementById("jumpSound");
    const coinSound = document.getElementById("coinSound");
    const gameOverSound = document.getElementById("gameOverSound");


    const firebaseConfig = { /* ... Your Firebase Config ... */
      apiKey: "AIzaSyCxqQEPU7qpEGleQXok7OFAyAouOrccoUY", authDomain: "test1-f9ef8.firebaseapp.com",
      databaseURL: "https://test1-f9ef8-default-rtdb.firebaseio.com", projectId: "test1-f9ef8",
      storageBucket: "test1-f9ef8.appspot.com", messagingSenderId: "709839711061",
      appId: "1:709839711061:web:ae8cc321d2ddac66c91ddc", measurementId: "G-K4Q94MBQDT"
    };

    // --- Firebase Initialization ---
    let appFirebase, db, auth;
    try {
        appFirebase = initializeApp(firebaseConfig); db = getDatabase(appFirebase); auth = getAuth();
        console.log("Firebase initialized successfully.");
    } catch (error) { console.error("Firebase init failed:", error); alert("Connection error."); }

    // --- Global State Variables ---
    let totalCoins = 0;
    let soundEnabled = true; // Sound ON by default
    let currentUserInviteCode = null;
    let gameStarted = false;
    let gameOver = false;
    let score = 0;
    let mario, obstacles, coins, speed, bgX, platformX;
    let lastJumpInputTime = 0; const doubleJumpWindow = 350; let canDoubleJump = false;
    let animationFrameId = null;
    let allImagesLoaded = false;
    let restartAttempts = 0; // Counter for restart ad logic

    // --- AD INTEGRATION ---
    const directLinkUrl = "https://www.profitableratecpm.com/ycus2u5z?key=6d1f652cb3c1d695c1a7cb556f20002a";
    let adCloseTimerInterval; let adCloseTimeout; let currentAdCallback = null;
    function showInterstitialAd(callback) {
      console.log("showInterstitialAd called");
      if (typeof callback !== 'function') { console.error("Invalid callback provided to showInterstitialAd."); return; }
      currentAdCallback = callback;
      adInfoText.textContent = "Advertisement loading..."; interstitialAdOverlay.style.display = 'flex';
      interstitialAdCloseButton.style.display = 'none'; interstitialAdTimer.textContent = "";
      try {
        const adWindow = window.open(directLinkUrl, '_blank');
        if (!adWindow) { console.warn("Pop-up blocked? Please disable pop-up blockers to continue."); adInfoText.textContent = "Please disable pop-up blockers."; }
      } catch (e) { console.error("Error opening ad window:", e); adInfoText.textContent = "Could not open ad."; }
      let secondsRemaining = 3; interstitialAdTimer.textContent = `Skip in ${secondsRemaining}s`;
      if (adCloseTimerInterval) clearInterval(adCloseTimerInterval); if (adCloseTimeout) clearTimeout(adCloseTimeout);
      adCloseTimerInterval = setInterval(() => {
        secondsRemaining--;
        if (secondsRemaining > 0) { interstitialAdTimer.textContent = `Skip in ${secondsRemaining}s`; }
        else { interstitialAdTimer.textContent = "You can skip now."; clearInterval(adCloseTimerInterval); }
      }, 1000);
      adCloseTimeout = setTimeout(() => {
        interstitialAdCloseButton.style.display = 'block'; if (adCloseTimerInterval) clearInterval(adCloseTimerInterval);
        interstitialAdTimer.textContent = "You can skip now.";
      }, secondsRemaining * 1000 + 100); // Add a slight delay
    }
    interstitialAdCloseButton.addEventListener('click', () => {
      console.log("Interstitial Ad Close Button clicked"); interstitialAdOverlay.style.display = 'none';
      if (adCloseTimerInterval) clearInterval(adCloseTimerInterval); if (adCloseTimeout) clearTimeout(adCloseTimeout);
      interstitialAdTimer.textContent = "";
      if (typeof currentAdCallback === 'function') {
        console.log("Executing ad callback function."); try { currentAdCallback(); } catch(e) { console.error("Error executing ad callback:", e); alert("An error occurred after the ad."); }
        currentAdCallback = null; // Clear callback after execution
      } else { console.warn("No ad callback function found to execute."); }
    });
    // --- END AD INTEGRATION ---

    // --- Sound Functions ---
    function playSound(audioElement) {
        if (soundEnabled && audioElement) {
             if (typeof audioElement.play === 'function' && typeof audioElement.load === 'function') {
                 audioElement.currentTime = 0; // Reset for quick replay
                 audioElement.play().catch(e => console.log(`Sound play error (${audioElement.id}):`, e));
             } else {
                  console.warn("Attempted to play invalid audio element:", audioElement ? audioElement.id : 'null');
             }
        }
    }

    // MODIFIED: Function to handle playing background music
    function playBackgroundMusic() {
        if (soundEnabled && backgroundAudio && backgroundAudio.paused) { // Check if paused and sound enabled
            console.log("Attempting to play background music...");
            // Browsers often block autoplay until user interaction
            backgroundAudio.play().then(() => {
                console.log("Background music playing.");
            }).catch(e => {
                console.warn("Background music play failed (maybe needs user interaction first?):", e);
                // Might need a click/tap listener on the body once to unlock audio context
            });
        } else if (!soundEnabled) {
            // console.log("Background music not played: Sound disabled.");
        } else if (backgroundAudio && !backgroundAudio.paused) {
            // console.log("Background music already playing.");
        }
    }

    // MODIFIED: Function to stop background music
    function stopBackgroundMusic() {
        if (backgroundAudio && !backgroundAudio.paused) { // Check if playing
            console.log("Stopping background music.");
            backgroundAudio.pause();
            backgroundAudio.currentTime = 0; // Reset position for next play
        }
    }
    // --- End Sound Functions ---

    // --- Authentication Logic ---
    function handleLoginSignupSuccess() {
      console.log("Login/Signup successful. Showing ad before proceeding.");
      showInterstitialAd(() => {
        console.log("Ad callback after login/signup: Loading data & showing main menu.");
        loginPanel.style.display = "none";
        loadUserCoins();
        loadInviteCode();
        showMainMenu(); // This will now handle playing background music
        checkUrlForReferral();
      });
    }
    document.getElementById("loginButton").addEventListener("click", () => {
      const e = document.getElementById("loginEmail").value, p = document.getElementById("loginPassword").value;
      if(!e||!p){alert("Please enter both email and password.");return;}
      signInWithEmailAndPassword(auth,e,p)
        .then(handleLoginSignupSuccess)
        .catch(err=>{console.error("Login Error:",err);alert("Login Error: "+err.message);});
    });
    document.getElementById("signupButton").addEventListener("click", () => {
      const e=document.getElementById("loginEmail").value, p=document.getElementById("loginPassword").value;
      if(!e||!p){alert("Please enter both email and password.");return;}
      if(p.length<6){alert("Password must be at least 6 characters long.");return;}
      createUserWithEmailAndPassword(auth,e,p)
        .then(cred=>{
            const u=cred.user; console.log("Signup Success, user created:",u.uid);
            // Initialize user data in DB
            return set(ref(db,"users/"+u.uid),{email:u.email,uid:u.uid,totalCoins:0,referralCount:0,referralRedeemed:false});
        })
        .then(()=>{
            console.log("User data initialized in database.");
            handleLoginSignupSuccess();
        })
        .catch(err=>{
            console.error("Signup Error:",err);
            if(err.code==='auth/email-already-in-use'){
                alert("This email is already registered. Please log in instead.");
            } else {
                alert("Signup Error: "+err.message);
            }
        });
    });
    document.getElementById("guestButton").addEventListener("click", () => {
      console.log("Continuing as Guest.");
      loginPanel.style.display = "none";
      resetAppStateToLoggedOut(); // Resets state but doesn't sign out (as there's no user)
      showMainMenu(); // This will now handle playing background music
      checkUrlForReferral();
    });

    // --- Auth State Change Listener ---
    onAuthStateChanged(auth, (user) => {
      if(user){
          console.log("Auth State Changed: User is Signed In", user.uid);
          // If the login panel isn't showing, it means the user was already logged in or just finished logging in via another flow
          if(loginPanel.style.display !== 'flex'){
              console.log("User already authenticated, ensuring main menu is shown.");
              loadUserCoins();
              loadInviteCode();
              showMainMenu(); // Ensure menu is shown and music starts if needed
              checkUrlForReferral();
          } else {
              // If login panel IS showing, the login/signup success handler will manage the transition
              console.log("Auth state change detected, but login panel is active. Login flow will handle UI.");
          }
      } else {
          console.log("Auth State Changed: User is Signed Out");
          resetAppStateToLoggedOut(); // Resets state and stops music
          // Show login panel, hide everything else
          loginPanel.style.display="flex";
          mainMenu.style.display="none";
          gameCanvas.style.display='none';
          gameOverMenu.style.display='none';
          settingsModal.style.display="none";
          inviteModal.style.display="none";
          withdrawModal.style.display="none";
          infoModal.style.display="none";
      }
    });

    // MODIFIED: Reset App State also stops music
    function resetAppStateToLoggedOut() {
      console.log("Resetting app state to logged out / guest mode.");
      totalCoins=0; currentUserInviteCode=null; gameStarted=false; gameOver=false; score=0;
      if(animationFrameId) cancelAnimationFrame(animationFrameId); animationFrameId=null;
      stopBackgroundMusic(); // Ensure music stops
      menuCoinCountSpan.innerText="0"; finalTotalCoinsSpan.innerText="0"; updateInviteButtonText(0);
      yourInviteCodeP.textContent="N/A (Guest)";
      mario=null; obstacles=[]; coins=[];
      restartAttempts=0; // Reset restart counter
    }

    // --- Data Loading ---
    function loadUserCoins() {
      const u=auth.currentUser;
      if(u){
          get(ref(db,"users/"+u.uid+"/totalCoins")).then(s=>{
              totalCoins=s.exists()?s.val():0;
              menuCoinCountSpan.innerText=totalCoins;
              finalTotalCoinsSpan.innerText=totalCoins; // Keep final total updated too
          }).catch(e=>{console.error("Coin load error:",e);totalCoins=0;menuCoinCountSpan.innerText=0;finalTotalCoinsSpan.innerText=0;});
      } else {
          // Guest mode or error
          totalCoins=0; menuCoinCountSpan.innerText=0; finalTotalCoinsSpan.innerText=0;
      }
    }
    function loadInviteCode() {
      const u=auth.currentUser;
      if(u){
          get(ref(db,"users/"+u.uid)).then(s=>{
              if(s.exists()){
                  const d=s.val();
                  if(!d.inviteCode){
                      // Generate and save if missing
                      const c=generateRandomCode();
                      set(ref(db,"users/"+u.uid+"/inviteCode"),c).then(()=>{
                          currentUserInviteCode=c; yourInviteCodeP.textContent=c;
                          console.log("Generated and saved new invite code:", c);
                      }).catch(e=>{console.error("Error setting invite code:",e);yourInviteCodeP.textContent="Error";});
                  } else {
                      currentUserInviteCode=d.inviteCode; yourInviteCodeP.textContent=currentUserInviteCode;
                  }
                  loadReferralCount(); // Load count after getting user data
              } else {
                  console.warn("User node missing in DB:",u.uid); yourInviteCodeP.textContent="Error"; currentUserInviteCode=null; loadReferralCount(); // Still try to load count (will be 0)
              }
          }).catch(e=>{console.error("Error getting user data for invite code:",e);yourInviteCodeP.textContent="Error";});
      } else {
          // Guest mode
          yourInviteCodeP.textContent="N/A (Guest)"; currentUserInviteCode=null; updateInviteButtonText(0);
      }
    }
    function loadReferralCount() {
      const u=auth.currentUser;
      if(u){
          get(ref(db,"users/"+u.uid+"/referralCount")).then(s=>{
              updateInviteButtonText(s.exists()?s.val():0);
          }).catch(e=>{console.error("Error loading referral count:",e);updateInviteButtonText(0);});
      } else {
          // Guest mode
          updateInviteButtonText(0);
      }
    }
    function checkUrlForReferral() {
      const p=new URLSearchParams(window.location.search),c=p.get('ref');
      if(c&&auth.currentUser&&redeemCodeInput){
          redeemCodeInput.value=c.trim().toUpperCase();
          console.log("Referral code found in URL and pre-filled:",c);
          // Clean the URL
          try{window.history.replaceState({},document.title,window.location.pathname);}catch(e){console.warn("URL cleaning failed:",e);}
      }
    }

    // --- UI Update ---
    function updateInviteButtonText(count) { inviteFriendBtn.innerText = `Invite (${count || 0} Refs)`; }
    function updateSoundButton() {
      toggleSoundBtn.textContent=`Sound: ${soundEnabled?'On':'Off'}`;
      const onStyle="linear-gradient(145deg, #2ed573, #1dd1a1)"; const offStyle="linear-gradient(145deg, #8395a7, #576574)";
      toggleSoundBtn.style.background=soundEnabled?onStyle:offStyle;
      toggleSoundBtn.style.borderBottomColor=soundEnabled?'#10ac84':'#2f3640';
    }

    // --- View Navigation ---
    // MODIFIED: showMainMenu now attempts to play background music
    function showMainMenu() {
      console.log("Navigating to Main Menu");
      gameStarted=false; gameOver=false;
      if(animationFrameId){cancelAnimationFrame(animationFrameId); animationFrameId=null;}

      // Hide other views
      loginPanel.style.display="none";gameOverMenu.style.display="none";gameCanvas.style.display="none";
      settingsModal.style.display="none";inviteModal.style.display="none";withdrawModal.style.display="none";infoModal.style.display="none";

      // Show main menu
      mainMenu.style.display="flex";
      loadUserCoins(); // Refresh coin display
      // stopBackgroundMusic(); // Don't stop if coming from game over, let it play
      playBackgroundMusic(); // Attempt to play music when entering the menu
    }
     function showGameOverMenu() {
       console.log("Navigating to Game Over Menu");
       sessionCoinCountSpan.innerText=score;
       finalTotalCoinsSpan.innerText=totalCoins; // Ensure total is up-to-date
       gameOverMenu.style.display="flex";
       mainMenu.style.display="none";
       gameCanvas.style.display='none';
       // Music should have been stopped by checkCollision already
     }

    // --- Settings Modal ---
    document.getElementById("settingsBtn").addEventListener("click", () => { updateSoundButton(); settingsModal.style.display = "block"; }); // Update button state when opening
    document.getElementById("closeSettings").addEventListener("click", () => { settingsModal.style.display = "none"; });
    // MODIFIED: Toggle sound button logic
    toggleSoundBtn.addEventListener("click", () => {
      soundEnabled = !soundEnabled;
      updateSoundButton();
      if (!soundEnabled) {
          stopBackgroundMusic();
          // Optionally stop all sound effects immediately if needed
          // jumpSound.pause(); jumpSound.currentTime = 0;
          // coinSound.pause(); coinSound.currentTime = 0;
          // gameOverSound.pause(); gameOverSound.currentTime = 0;
      } else {
          // Try to play background music if we are in the menu or in an active game
          if (mainMenu.style.display === 'flex' || (gameStarted && !gameOver)) {
               playBackgroundMusic();
          }
      }
    });
    document.getElementById("customerService").addEventListener("click", () => { window.open("https://wa.me/923019022815", "_blank"); });

    // --- Invite Logic ---
    const baseInviteUrl = window.location.origin + window.location.pathname;
    function generateRandomCode() { return Math.random().toString(36).substring(2, 8).toUpperCase(); }
    function redeemInviteCode(code) {
      const u=auth.currentUser;
      if(!u){alert("Please log in to redeem codes.");return;}
      if(!code){alert("Please enter a code.");return;}
      code = code.trim().toUpperCase(); // Sanitize
      if(code === currentUserInviteCode){alert("You cannot redeem your own invite code.");return;}

      let refId=null, refData=null, refCount=0, currentUserData = null;

      // 1. Check if current user already redeemed a code
      get(ref(db,"users/"+u.uid)).then(userSnap => {
          if (!userSnap.exists()) throw new Error("Current user data not found.");
          currentUserData = userSnap.val();
          if (currentUserData.referralRedeemed === true) {
              throw new Error("You have already redeemed an invite code.");
          }
          // 2. Find the user with the entered code
          const q = query(ref(db, "users"), orderByChild("inviteCode"), equalTo(code));
          return get(q);
      }).then(snap => {
          if (!snap.exists()) { throw new Error("Invalid or expired invite code."); }
          // 3. Ensure the found code doesn't belong to the current user
          snap.forEach(childSnapshot => {
              if (childSnapshot.key !== u.uid) { // Check if it's not the current user's key
                  refId = childSnapshot.key;
                  refData = childSnapshot.val();
              }
          });
          if (!refId || !refData) { throw new Error("Invalid invite code or you tried to redeem your own."); } // Should be caught earlier, but double-check
          // 4. Prepare updates
          refCount = refData.referralCount || 0;
          const referrerBonus = 200; // Coins for the person redeeming
          const referredFriendBonus = 100; // Coins for the owner of the code
          const newCurrentUserCoins = (currentUserData.totalCoins || 0) + referrerBonus;
          const newReferrerCoins = (refData.totalCoins || 0) + referredFriendBonus;

          console.log(`Redeeming code ${code}. Referrer: ${refId}, Current User: ${u.uid}`);
          console.log(`Current user gets ${referrerBonus}, new total: ${newCurrentUserCoins}`);
          console.log(`Referrer gets ${referredFriendBonus}, new total: ${newReferrerCoins}. New ref count: ${refCount + 1}`);

          // 5. Perform atomic updates (or as close as possible without transactions)
          const updates = {};
          updates[`/users/${u.uid}/totalCoins`] = newCurrentUserCoins;
          updates[`/users/${u.uid}/referralRedeemed`] = true;
          updates[`/users/${refId}/totalCoins`] = newReferrerCoins;
          updates[`/users/${refId}/referralCount`] = refCount + 1;

          // Using set for simplicity here, could use update(ref(db), updates) for multi-path
          return Promise.all([
              set(ref(db, `users/${u.uid}/totalCoins`), newCurrentUserCoins),
              set(ref(db, `users/${u.uid}/referralRedeemed`), true),
              set(ref(db, `users/${refId}/totalCoins`), newReferrerCoins),
              set(ref(db, `users/${refId}/referralCount`), refCount + 1)
          ]).then(() => ({ newCoins: newCurrentUserCoins, rBonus: referrerBonus, fBonus: referredFriendBonus })); // Pass data for alert

      }).then(({newCoins, rBonus, fBonus}) => {
          totalCoins = newCoins; // Update local state
          menuCoinCountSpan.innerText = totalCoins;
          finalTotalCoinsSpan.innerText = totalCoins; // Update game over screen too
          loadReferralCount(); // Refresh inviter's count (if they are the current user, unlikely but possible)
          alert(`Code redeemed successfully!\nYou received ${rBonus} coins.\nYour friend received ${fBonus} coins.`);
          inviteModal.style.display = "none"; // Close modal
          redeemCodeInput.value = ""; // Clear input
      }).catch(err => {
          console.error("Redeem Invite Code Error:", err);
          alert("Error redeeming code: " + err.message);
      });
    }
    inviteFriendBtn.addEventListener("click", () => { if (!auth.currentUser) { alert("Please log in to access invites."); return; } loadInviteCode(); inviteModal.style.display = "block"; }); // Load latest code when opening
    document.getElementById("closeInviteModal").addEventListener("click", () => { inviteModal.style.display = "none"; });
    document.getElementById("copyInviteCode").addEventListener("click", () => {
      if(currentUserInviteCode && currentUserInviteCode!=="Loading..." && currentUserInviteCode!=="N/A (Guest)" && currentUserInviteCode!=="Error"){
          const inviteLink = `${baseInviteUrl}?ref=${currentUserInviteCode}`;
          navigator.clipboard.writeText(inviteLink).then(()=>alert("Invite link copied to clipboard!"))
          .catch(err=>{alert("Failed to copy link.");console.error('Clipboard copy failed:',err);});
      }else{alert("Invite link is not available.");}
    });
    document.getElementById("redeemCodeBtn").addEventListener("click", () => { const c=redeemCodeInput.value; if(c)redeemInviteCode(c);else alert("Please enter an invite code."); });

    // --- Withdraw Logic ---
    let selectedWithdrawCoins = 0; let selectedWithdrawPKR = 0;
    document.getElementById("withdrawBtn").addEventListener("click", () => {
      if(!auth.currentUser){alert("Please log in to withdraw coins.");return;}
      loadUserCoins(); // Refresh coins before showing options
      redeemOptionsDiv.style.display="block"; // Show options first
      redeemFormDiv.style.display="none"; // Hide form initially
      redeemDetailsForm.reset(); // Clear previous form data
      redeemSubmitBtn.disabled=false; redeemSubmitBtn.textContent="Submit Request"; // Reset button state
      withdrawModal.style.display="block";
    });
    document.getElementById("closeWithdraw").addEventListener("click", () => { withdrawModal.style.display = "none"; });
    redeemOptionsDiv.querySelectorAll('.redeem-option').forEach(button => {
        button.addEventListener('click', () => {
            selectedWithdrawCoins=parseInt(button.getAttribute('data-coins'),10);
            selectedWithdrawPKR=parseInt(button.getAttribute('data-pkr'),10);
            if(totalCoins < selectedWithdrawCoins){
                alert(`You need ${selectedWithdrawCoins} coins for this option. You have ${totalCoins}.`);
                return;
            }
            // If sufficient coins, hide options and show form
            redeemOptionsDiv.style.display='none';
            redeemFormDiv.style.display='block';
        });
    });
    redeemDetailsForm.addEventListener('submit', (e) => {
        e.preventDefault(); // Prevent default form submission
        const name=document.getElementById('accountHolderName').value.trim();
        const num=document.getElementById('accountNumber').value.trim();
        const methodInput=document.querySelector('input[name="paymentMethod"]:checked');

        if(!name || !num || !methodInput){ alert("Please fill in all fields and select a payment method."); return; }
        if(totalCoins < selectedWithdrawCoins){ alert(`Error: Insufficient coins. You need ${selectedWithdrawCoins}, but have ${totalCoins}.`); withdrawModal.style.display = "none"; return; }

        const user=auth.currentUser; if(!user){ alert("Authentication error. Please log in again."); withdrawModal.style.display="none"; return; }
        const method=methodInput.value;
        const requestData={
            uid: user.uid, email: user.email || "N/A",
            withdrawalAmountCoins: selectedWithdrawCoins, pkrAmount: selectedWithdrawPKR,
            accountHolderName: name, accountNumber: num, paymentMethod: method,
            status: "pending", timestamp: Date.now() // Use server timestamp if available, otherwise client time
        };

        redeemSubmitBtn.disabled=true; redeemSubmitBtn.textContent="Submitting...";

        // 1. Push the request to the database
        push(ref(db,"withdrawRequests"), requestData)
        .then((newRequestRef)=>{
            console.log("Withdrawal request submitted successfully:", newRequestRef.key);
            // 2. Deduct coins from the user's total
            const newTotalCoins = totalCoins - selectedWithdrawCoins;
            return set(ref(db,"users/"+user.uid+"/totalCoins"), newTotalCoins);
        })
        .then(()=>{
            console.log("User coins updated successfully.");
            // 3. Update local state and UI
            totalCoins -= selectedWithdrawCoins;
            menuCoinCountSpan.innerText = totalCoins;
            finalTotalCoinsSpan.innerText = totalCoins;
            alert(`Withdrawal request for ${selectedWithdrawPKR} PKR submitted successfully! Please allow some time for processing.`);
            withdrawModal.style.display = "none"; // Close modal on success
        })
        .catch(err=>{
            alert("Error submitting withdrawal request: "+err.message);
            console.error("Withdrawal submission error:", err);
            redeemSubmitBtn.disabled=false; // Re-enable button on error
            redeemSubmitBtn.textContent="Submit Request";
        });
    });

    // --- Info Modal ---
    document.getElementById("infoBtn").addEventListener("click", () => { infoModal.style.display = "block"; });
    document.getElementById("closeInfo").addEventListener("click", () => { infoModal.style.display = "none"; });

    // --- Logout ---
    document.getElementById("logoutBtn").addEventListener("click", () => {
        signOut(auth).catch((error) => { alert("Logout error: " + error.message); });
        // onAuthStateChanged listener will handle UI changes and stopping music
    });

    // --- Game Engine Code ---
    const ctx = gameCanvas.getContext("2d");
    function resizeCanvas() {
      gameCanvas.width=window.innerWidth;
      const bannerH=document.getElementById('bannerAdContainer')?.offsetHeight||50;
      gameCanvas.height=window.innerHeight-bannerH;
      // Adjust Mario's position if resizing causes him to fall through floor
      if(gameStarted && mario){
          const groundY=gameCanvas.height-50;
          if(mario.y+mario.height >= groundY-5 || !mario.isJumping){ // If on ground or slightly below
              mario.y = groundY - mario.height; // Snap to ground
              mario.dy = 0;
              mario.isJumping=false;
              canDoubleJump=false;
          }
      }
    }
    window.addEventListener("resize", resizeCanvas);

    // --- Image Loading ---
    const imagesToLoad = { character:"https://i.imgur.com/AbfH2aB.png",background:"https://i.imgur.com/xZpZqGt.png",enemy:"https://i.imgur.com/TsR4WXH.png",coin:"https://i.imgur.com/cMQ9X0d.png",platform:"https://i.imgur.com/06ptzal.png"};
    const gameImages = {}; let imagesLoadedCount = 0; let totalImagesToLoad = Object.keys(imagesToLoad).length;
    function checkAllImagesLoaded() { imagesLoadedCount++; if (imagesLoadedCount === totalImagesToLoad) { allImagesLoaded = true; console.log("All game images loaded."); } }
    for (const key in imagesToLoad) { gameImages[key] = new Image(); gameImages[key].onload = checkAllImagesLoaded; gameImages[key].onerror = () => { console.error("Failed to load image:", key, imagesToLoad[key]); totalImagesToLoad--; }; gameImages[key].src = imagesToLoad[key]; }

    // --- Game Initialization ---
    // MODIFIED: initGame now also calls playBackgroundMusic
    function initGame() {
      if (!allImagesLoaded) { alert("Game assets are still loading. Please wait a moment."); return; }
      console.log("Initializing game state..."); resizeCanvas(); // Ensure canvas is sized correctly
      bgX=0; platformX=0; const groundY=gameCanvas.height-50;
      mario={x:60,y:groundY-60,width:40,height:60,dy:0,gravity:1.6,jumpPower:-22,doubleJumpPower:-18,isJumping:false};
      obstacles=[]; coins=[]; speed=6; score=0; gameOver=false; gameStarted=true;
      lastJumpInputTime=0; canDoubleJump=false;
      // Note: restartAttempts is reset in handleGameOver, not here, to persist across restarts until the ad threshold.
      if(animationFrameId) cancelAnimationFrame(animationFrameId); // Clear any previous loop
      playBackgroundMusic(); // Attempt to play/resume background music when game starts
      gameLoop(); // Start the game loop
    }

    // --- Drawing Functions ---
    function drawBackground() { if (!gameImages.background?.complete) return; bgX = (bgX - speed * 0.4) % gameImages.background.width; ctx.drawImage(gameImages.background, bgX, 0, gameImages.background.width, gameCanvas.height); ctx.drawImage(gameImages.background, bgX + gameImages.background.width, 0, gameImages.background.width, gameCanvas.height); }
    function drawPlatform() { if (!gameImages.platform?.complete) return; const groundY = gameCanvas.height - 50; platformX = (platformX - speed) % gameImages.platform.width; ctx.drawImage(gameImages.platform, platformX, groundY, gameImages.platform.width, 50); ctx.drawImage(gameImages.platform, platformX + gameImages.platform.width, groundY, gameImages.platform.width, 50); }
    function drawMario() { if (!mario || !gameImages.character?.complete) return; ctx.drawImage(gameImages.character, mario.x, mario.y, mario.width, mario.height); }
    function drawObstacles() { if (!gameImages.enemy?.complete) return; for (let i = obstacles.length - 1; i >= 0; i--) { let obs = obstacles[i]; obs.x -= speed; ctx.drawImage(gameImages.enemy, obs.x, obs.y, obs.width, obs.height); if (obs.x + obs.width < 0) obstacles.splice(i, 1); } }
    function spawnObstacles() {
        if(gameOver || !gameImages.enemy?.complete) return; // Don't spawn if game over or image not ready
        const baseMinDist = 350; const baseMaxDist = 650; const difficultyFactor = Math.max(0.1, 1 - (score / 800)); // Gets harder faster, minimum 10% range
        const currentMinDist = baseMinDist * difficultyFactor;
        const currentMaxDist = baseMaxDist * difficultyFactor;
        const distanceRange = Math.max(50, currentMaxDist - currentMinDist); // Ensure minimum range
        const randomDistance = currentMinDist + Math.random() * distanceRange;

        let lastObstacleX = obstacles.length > 0 ? obstacles[obstacles.length - 1].x : -randomDistance; // Position relative to last obstacle or initial distance

        // Check if space available from the right edge of the screen based on the last obstacle's position
        if (gameCanvas.width - lastObstacleX > randomDistance && obstacles.length < 5) { // Limit max obstacles on screen
            const groundY=gameCanvas.height-50;
            obstacles.push({x: gameCanvas.width + 10, y: groundY - 50, width: 50, height: 50}); // Spawn off-screen right
        }
    }
    function spawnCoins() {
        if(!gameImages.coin?.complete || gameOver) return; // Don't spawn if image not ready or game over
        const coinSpawnChance=0.025; // % chance per frame
        if(coins.length < 25 && Math.random() < coinSpawnChance){ // Limit total coins on screen
            const groundY=gameCanvas.height-50;
            let startY=groundY-30; // Default height slightly above ground
            if(Math.random()<0.4) { // 40% chance to spawn higher
                startY = groundY - 80 - (Math.random()*60); // Random height higher up
            }
            let coinCount = Math.floor(Math.random()*4)+2; // Spawn 2-5 coins in a line
            let startX = gameCanvas.width + Math.random() * 100; // Spawn off-screen right, with some variance
            const spacing = 45; // Horizontal spacing between coins
            for(let i=0; i < coinCount; i++){
                coins.push({x: startX + i * spacing, y: startY, width: 25, height: 25});
            }
        }
    }

    // --- Coin Collection with Sound ---
    function drawCoins() {
        if (!gameImages.coin?.complete || !mario || gameOver) return; // Ensure prerequisites
        const user = auth.currentUser;
        for (let i = coins.length - 1; i >= 0; i--) { // Loop backwards for safe removal
            let coin = coins[i]; coin.x -= speed; // Move coin left
            ctx.drawImage(gameImages.coin, coin.x - coin.width / 2, coin.y - coin.height / 2, coin.width, coin.height); // Draw centered

            // Collision check (simple bounding box)
            if ( mario.x < coin.x + coin.width / 2 && mario.x + mario.width > coin.x - coin.width / 2 &&
                 mario.y < coin.y + coin.height / 2 && mario.y + mario.height > coin.y - coin.height / 2 ) {
                coins.splice(i, 1); // Remove coin
                score +=  1; // Increment session score
                playSound(coinSound); // Play coin collection sound
                if (user) {
                    totalCoins += 1; // Increment total coins IF logged in
                    // Update UI immediately (optional, could batch update)
                    // menuCoinCountSpan.innerText = totalCoins;
                    // finalTotalCoinsSpan.innerText = totalCoins; // Keep game over screen total potentially updated
                }
            } else if (coin.x + coin.width < 0) {
                 coins.splice(i, 1); // Remove coin if it goes off-screen left
            }
        }
    }

    // --- Physics and Collision ---
    function applyPhysics() {
        if(!mario || gameOver) return; // Don't apply physics if no mario or game over
        mario.dy += mario.gravity; // Apply gravity
        mario.y += mario.dy; // Update vertical position
        const groundY=gameCanvas.height-50;
        // Check for ground collision
        if(mario.y + mario.height >= groundY){
            mario.y = groundY - mario.height; // Snap to ground
            mario.dy = 0; // Stop vertical movement
            if(mario.isJumping){ // Only reset jump state if landing
                mario.isJumping = false;
                canDoubleJump = false; // Reset double jump ability on landing
            }
        }
        // Prevent going off the top of the screen
        if(mario.y < 0){
            mario.y = 0; mario.dy = 0;
        }
    }

    // --- Collision with Game Over Sound ---
    // MODIFIED: Stops background music and plays game over sound on collision
    function checkCollision() {
      if (!mario || gameOver) return; // Skip if no mario or already game over
      for (let i=obstacles.length-1; i>=0; i--) { // Check against all obstacles
        let obs=obstacles[i];
        // Simple bounding box collision detection
        if (mario.x < obs.x + obs.width && mario.x + mario.width > obs.x &&
            mario.y < obs.y + obs.height && mario.y + mario.height > obs.y) {
          console.log("Collision detected with obstacle!");
          gameOver = true; // Set game over flag
          stopBackgroundMusic(); // Stop background music immediately
          playSound(gameOverSound); // Play game over sound effect
          break; // Exit loop once collision is detected
        }
      }
    }

    // --- Jump with Sound ---
    function jump() {
        if(!gameStarted || gameOver || !mario) return; // Can only jump if game is active and not over
        const now = Date.now();
        const groundY = gameCanvas.height - 50;
        const onGround = mario.y + mario.height >= groundY - 5; // Allow slight tolerance for being "on ground"

        let jumped = false; // Flag to track if a jump actually happens

        // Double Jump Logic: Must be already jumping, have double jump available, and within time window
        if(mario.isJumping && canDoubleJump && (now - lastJumpInputTime < doubleJumpWindow)){
            mario.dy = mario.doubleJumpPower; // Apply double jump force
            canDoubleJump = false; // Used double jump
            lastJumpInputTime = 0; // Reset timer to prevent triple+ jumps
            console.log("Double Jump!");
            jumped = true;
        }
        // First Jump Logic: Must be on the ground
        else if(onGround){
            mario.dy = mario.jumpPower; // Apply initial jump force
            mario.isJumping = true; // Set jumping state
            canDoubleJump = true; // Allow double jump after this initial jump
            lastJumpInputTime = now; // Record time of this jump for double jump window
            console.log("First Jump!");
            jumped = true;
        }

        // Play sound only if a jump action was successful
        if (jumped) {
            playSound(jumpSound);
        }
    }

    // --- Game Loop ---
    function gameLoop() {
      // Exit conditions
      if(gameOver || !gameStarted){
          if(gameOver) handleGameOver(); // Trigger game over logic if flag is set
          return; // Stop the loop
      }

      // Game Logic Updates
      applyPhysics();
      checkCollision(); // Check for collisions AFTER physics update
      if(gameOver){ // Check again if collision happened this frame
          handleGameOver();
          return;
      }
      spawnObstacles();
      spawnCoins();

      // Drawing Updates
      ctx.clearRect(0,0,gameCanvas.width,gameCanvas.height); // Clear canvas
      drawBackground();
      drawPlatform();
      drawObstacles();
      drawCoins(); // Draws and handles coin collection
      drawMario();

      // Draw Score UI
      ctx.fillStyle="#FFF"; ctx.font="20px 'Press Start 2P'"; ctx.textAlign="left"; ctx.textBaseline="top";
      ctx.shadowColor='black'; ctx.shadowBlur=4; ctx.shadowOffsetX=2; ctx.shadowOffsetY=2; // Add shadow for readability
      ctx.fillText("Score: "+score, 20, 20);
      ctx.shadowBlur=0; ctx.shadowOffsetX=0; ctx.shadowOffsetY=0; // Reset shadow

      // Request next frame
      animationFrameId=requestAnimationFrame(gameLoop);
    }

    // --- Handle Game Over ---
    // MODIFIED: Resets restartAttempts counter here
    function handleGameOver() {
         console.log("Handling Game Over. Final Session Score:", score);
         gameStarted = false; // Stop game logic
         const user = auth.currentUser;
         if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }
         // Music and sound effects should be handled by checkCollision

         // Reset the restart ad counter for the next game session
         restartAttempts = 0;
         console.log("Restart attempts counter reset to 0 for the next session.");

         // Save coins IF logged in and score > 0
         if (user && score > 0) {
             // Use the totalCoins variable which was updated during drawCoins
             console.log(`Saving total coins (${totalCoins}) for user ${user.uid}`);
             set(ref(db,"users/"+user.uid+"/totalCoins"), totalCoins).then(()=> {
                 console.log("Total coins saved successfully to database.");
             }).catch(e=> {
                 console.error("Error saving total coins to database:",e);
                 // Decide how to handle save errors - maybe alert the user?
             });
         } else if (user && score === 0) {
             console.log("Game Over - Score is 0, no coins to save.");
         } else {
             console.log("Game Over - User not logged in (Guest) or score is 0, coins not saved.");
         }

         // Display the game over menu
         showGameOverMenu();
    }

    // --- Game Control Button Listeners ---
    // Start Button: Always show ad before starting
    document.getElementById("startBtn").addEventListener("click", () => {
        if (!allImagesLoaded) { alert("Game assets are still loading..."); return; }
        console.log("Start button clicked. Showing interstitial ad.");
        showInterstitialAd(() => {
            console.log("Ad callback after Start button: Initializing game.");
            mainMenu.style.display = "none";
            gameCanvas.style.display = 'block';
            initGame(); // Initialize and start the game
        });
    });

    // Restart Button: Show ad only on 3rd+ attempt in a row
    document.getElementById("restartBtn").addEventListener("click", () => {
        if (!allImagesLoaded) { alert("Game assets error. Returning to menu."); showMainMenu(); return; }

        restartAttempts++; // Increment attempt counter for this game over sequence
        console.log(`Restart attempt number: ${restartAttempts}`);

        const performRestart = () => {
            console.log("Executing game restart action.");
            gameOverMenu.style.display = "none"; // Hide game over menu
            gameCanvas.style.display = 'block'; // Show canvas
            initGame(); // Re-initialize game state and start the loop
        };

        if (restartAttempts >= 3) {
            console.log("Restart attempt 3 or more. Showing interstitial ad.");
            showInterstitialAd(() => {
                console.log("Ad callback after Restart button (attempt >= 3): Performing restart.");
                // IMPORTANT: Do NOT reset restartAttempts here. It resets naturally in handleGameOver when a *new* game over occurs.
                performRestart();
            });
        } else {
            console.log(`Restarting immediately (attempt ${restartAttempts} < 3).`);
            performRestart(); // Restart directly without showing an ad
        }
    });

    // Back to Menu Button
    document.getElementById("backMenuBtn").addEventListener("click", showMainMenu); // Calls the function that shows menu and plays music

    // --- Jump Event Listeners ---
    document.addEventListener("keydown", (e) => { if ((e.code === "Space" || e.code === "ArrowUp") && gameStarted && !gameOver) { e.preventDefault(); jump(); } });
    // Use click for mouse interaction on canvas
    gameCanvas.addEventListener("click", (e) => { if (gameStarted && !gameOver) { e.preventDefault(); jump(); } });
    // Use touchstart for touch devices on canvas
    gameCanvas.addEventListener("touchstart", (e) => { if (gameStarted && !gameOver) { e.preventDefault(); jump(); } }, { passive: false }); // passive:false needed to allow preventDefault

    // --- Initial Setup ---
    console.log("Running initial page setup...");
    // Initial UI state is handled by the onAuthStateChanged listener.
    // It will show the login panel by default if no user is signed in.
    loginPanel.style.display = "flex"; // Start with login panel visible
    mainMenu.style.display = "none";
    gameCanvas.style.display = "none";
    gameOverMenu.style.display = "none";
    updateSoundButton(); // Set initial sound button text/style

    // Attempt to unlock audio context with a first interaction (optional but good practice)
    /*
    function unlockAudio() {
        console.log("Attempting to unlock audio context.");
        const allAudio = document.querySelectorAll('audio');
        let unlocked = false;
        allAudio.forEach(audio => {
            if (!unlocked) {
                audio.play().then(() => {
                    audio.pause(); // Play and immediately pause to unlock
                    unlocked = true;
                    console.log("Audio context likely unlocked.");
                    document.body.removeEventListener('click', unlockAudio);
                    document.body.removeEventListener('touchstart', unlockAudio);
                }).catch(() => {}); // Ignore errors, might already be unlocked
            }
        });
    }
    document.body.addEventListener('click', unlockAudio, { once: true });
    document.body.addEventListener('touchstart', unlockAudio, { once: true });
    */

  </script>
</body>
</html>